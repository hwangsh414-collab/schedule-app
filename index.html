<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í”Œë¡œìš° â€” ì¼ì • ê´€ë¦¬</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="í”Œë¡œìš°">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Gowun+Dodum&display=swap" rel="stylesheet">

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  // ì¸ì¦(Auth) ëª¨ë“ˆ ì¶”ê°€
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSy05jmwUC7uZk-2r-kVdqrXoorXDEWf3Sew",
    authDomain: "my-schedule-app-17d95.firebaseapp.com",
    projectId: "my-schedule-app-17d95",
    storageBucket: "my-schedule-app-17d95.firebasestorage.app",
    messagingSenderId: "335071986474",
    appId: "1:335071986474:web:b4b8c5178695826b685453"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  
  window._db = db;
  window._auth = auth;
  window._fb = { collection, addDoc, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot, serverTimestamp };
  window._fbAuth = { onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut };
  
  document.dispatchEvent(new Event('firebaseReady'));
</script>

<style>
:root {
  --bg:#F7F6F3; --surface:#fff; --surface2:#F0EEE9; --border:#E2DDD5;
  --text:#1C1917; --muted:#78716C;
  --accent:#2563EB; --accent-l:#EFF6FF;
  --green:#059669; --green-l:#ECFDF5;
  --warn:#D97706; --warn-l:#FFFBEB;
  --red:#DC2626; --red-l:#FEF2F2;
  --purple:#7C3AED; --purple-l:#F5F3FF;
  --shadow:0 1px 3px rgba(0,0,0,.07),0 1px 2px rgba(0,0,0,.05);
  --shadow-md:0 4px 12px rgba(0,0,0,.08),0 2px 4px rgba(0,0,0,.04);
  --r:12px; --rs:8px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px}

/* â”€â”€ Auth Overlay â”€â”€ */
.auth-overlay { position:fixed; inset:0; background:var(--bg); z-index:99999; display:flex; align-items:center; justify-content:center; padding: 20px; }
.auth-box { background:var(--surface); padding:40px; border-radius:var(--r); box-shadow:0 20px 40px rgba(0,0,0,.1); width:100%; max-width:360px; text-align:center; }
.auth-title { font-family:'Gowun Dodum', sans-serif; font-size:28px; color:var(--accent); margin-bottom:8px; font-weight:bold; }
.auth-sub { font-size:13px; color:var(--muted); margin-bottom:24px; }

/* â”€â”€ Layout â”€â”€ */
.shell{display:flex;min-height:100vh}
.sidebar{width:220px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;transition:transform .3s}
.logo{padding:24px 20px 20px;font-family:'Gowun Dodum',sans-serif;font-size:22px;color:var(--accent);letter-spacing:-.5px;border-bottom:1px solid var(--border)}
.logo span{color:var(--muted);font-size:12px;display:block;margin-top:2px}
.nav-sec{padding:12px 0}
.nav-lbl{padding:8px 20px 4px;font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-weight:700}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;cursor:pointer;font-size:14px;color:var(--muted);transition:all .15s;position:relative}
.nav-item:hover{background:var(--surface2);color:var(--text)}
.nav-item.active{background:var(--accent-l);color:var(--accent);font-weight:500}
.nav-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--accent);border-radius:0 2px 2px 0}
.ni{width:18px;height:18px;flex-shrink:0}
.main{margin-left:220px;flex:1;display:flex;flex-direction:column}
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.tb-l{display:flex;align-items:center;gap:12px}
.tb-title{font-size:20px;font-weight:700}
.tb-sub{font-size:12px;color:var(--muted);margin-top:2px}

/* â”€â”€ Buttons â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--rs);border:none;cursor:pointer;font-family:inherit;font-size:13px;font-weight:500;transition:all .15s}
.btn-p{background:var(--accent);color:#fff}
.btn-p:hover{background:#1D4ED8;transform:translateY(-1px);box-shadow:0 4px 12px rgba(37,99,235,.3)}
.btn-s{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn-s:hover{background:var(--border)}
.btn-d{background:var(--red-l);color:var(--red)}
.btn-d:hover{background:var(--red);color:#fff}
.btn-sm{padding:5px 10px;font-size:12px}
.btn-ic{padding:6px;border-radius:6px;background:transparent;border:1px solid var(--border)}
.btn-ic:hover{background:var(--surface2)}
.page{display:none;padding:28px 32px}
.page.active{display:block}

/* â”€â”€ Quick Prefix Buttons â”€â”€ */
.prefix-btn { font-size:10px; padding:2px 6px; border-radius:4px; background:var(--surface2); border:1px solid var(--border); cursor:pointer; color:var(--muted); transition:all .1s; }
.prefix-btn:hover { background:var(--accent-l); color:var(--accent); border-color:var(--accent); }
.prefix-btn.urg { background:var(--red-l); color:var(--red); border-color:var(--red-l); }
.prefix-btn.urg:hover { background:var(--red); color:#fff; border-color:var(--red); }

/* â”€â”€ Alarm bell â”€â”€ */
.bell-btn{position:relative;padding:8px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);cursor:pointer;font-size:18px;transition:all .15s}
.bell-btn:hover{background:var(--warn-l);border-color:var(--warn)}
.alarm-badge{position:absolute;top:-4px;right:-4px;background:var(--red);color:#fff;width:18px;height:18px;border-radius:50%;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}

/* â”€â”€ Alarm panel â”€â”€ */
.alarm-panel{position:fixed;top:70px;right:20px;width:320px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow-md);z-index:300;display:none}
.alarm-panel.open{display:block;animation:slideDown .2s}
@keyframes slideDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.ap-head{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:14px}
.ap-body{max-height:360px;overflow-y:auto}
.ai{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:10px}
.ai:last-child{border-bottom:none}
.ai-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0;margin-top:5px}
.ai-dot.urgent{background:var(--red);animation:pulse 1s infinite}
.ai-dot.soon{background:var(--warn)}
.ai-dismiss{margin-left:auto;background:none;border:none;cursor:pointer;color:var(--muted);font-size:14px;padding:2px 6px;border-radius:4px;flex-shrink:0}
.alarm-popup{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#fff;border-radius:var(--r);box-shadow:0 8px 40px rgba(0,0,0,.15);border-left:4px solid var(--accent);padding:16px 20px;z-index:9999;display:flex;align-items:center;gap:14px;min-width:300px;max-width:440px;animation:dropIn .35s cubic-bezier(.34,1.56,.64,1)}
.alarm-popup.urg{border-left-color:var(--red)}
@keyframes dropIn{from{opacity:0;transform:translateX(-50%) translateY(-20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.ap-close{background:var(--surface2);border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:12px;flex-shrink:0}

/* â”€â”€ Banners â”€â”€ */
.banner-warn{background:linear-gradient(135deg,#FEF3C7,#FDE68A);border:1px solid #F59E0B;border-radius:var(--r);padding:16px 20px;margin-bottom:24px;display:flex;align-items:center;gap:12px;font-size:13px}
.banner-info{background:linear-gradient(135deg,#EFF6FF,#DBEAFE);border:1px solid #93C5FD;border-radius:var(--r);padding:14px 18px;margin-bottom:16px;display:flex;align-items:center;gap:12px;font-size:13px}

/* â”€â”€ Calendar â”€â”€ */
.cal-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px;flex-wrap:wrap}
.cal-toolbar-l{display:flex;align-items:center;gap:8px}
.view-toggle{display:flex;gap:3px;background:var(--surface2);border-radius:var(--rs);padding:3px}
.vt-btn{padding:5px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--muted);transition:all .15s}
.vt-btn.active{background:var(--surface);color:var(--accent);box-shadow:var(--shadow)}

/* Monthly calendar */
.cal-layout{display:grid;grid-template-columns:1fr 300px;gap:20px}
.cal-card{background:var(--surface);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
.cal-head{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;border-bottom:1px solid var(--border)}
.cal-month{font-size:18px;font-weight:700}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr)}
.cal-wd{text-align:center;padding:10px 4px;font-size:11px;font-weight:700;color:var(--muted);border-bottom:1px solid var(--border)}
.cal-day{min-height:88px;padding:6px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;position:relative}
.cal-day:hover{background:var(--surface2)}
.cal-day.other .cal-dn{color:#C0BAB2}
.cal-day.today .cal-dn{background:var(--accent);color:#fff;width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center}
.cal-day.sel{background:var(--accent-l)}
.cal-dn{font-size:13px;font-weight:500;width:26px;height:26px;display:flex;align-items:center;justify-content:center;border-radius:50%}
.cal-dots{margin-top:3px;display:flex;flex-direction:column;gap:2px}
.cev{font-size:10px;padding:1px 5px;border-radius:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer}
.cev.meeting{background:var(--accent-l);color:var(--accent)}
.cev.task{background:var(--green-l);color:var(--green)}
.cev.deadline{background:var(--red-l);color:var(--red)}
.cev.reminder{background:var(--warn-l);color:var(--warn)}
.cev.recurring{background:#F5F3FF;color:var(--purple);font-style:italic}
.cev.has-alarm::before{content:'ğŸ””';font-size:8px;margin-right:2px}
.cev.more{background:var(--surface2);color:var(--muted)}
.cev.done, .wv-evt.done { text-decoration: line-through; opacity: 0.5; }

/* D-day badge */
.dday{display:inline-flex;align-items:center;padding:1px 6px;border-radius:10px;font-size:10px;font-weight:700;margin-left:4px}
.dday-today{background:var(--red);color:#fff}
.dday-soon{background:var(--warn-l);color:var(--warn);border:1px solid var(--warn)}
.dday-future{background:var(--surface2);color:var(--muted)}
.dday-past{background:#e5e7eb;color:#9ca3af;text-decoration:line-through}

/* Side panel */
.side-panel{background:var(--surface);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
.sp-head{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.sp-title{font-size:14px;font-weight:700}
.sp-body{padding:14px 18px}
.evt-list{display:flex;flex-direction:column;gap:8px}
.evt-item{background:var(--surface2);border-radius:var(--rs);padding:10px 12px;border-left:3px solid var(--accent);cursor:pointer;transition:all .15s}
.evt-item:hover{transform:translateX(2px);box-shadow:var(--shadow)}
.evt-item.meeting{border-color:var(--accent)}
.evt-item.task{border-color:var(--green)}
.evt-item.deadline{border-color:var(--red)}
.evt-item.reminder{border-color:var(--warn)}
.evt-item.recurring-task{border-color:var(--purple);border-style:dashed}

/* â”€â”€ Weekly View â”€â”€ */
.week-view{background:var(--surface);border-radius:var(--r);box-shadow:var(--shadow);overflow:auto}
.wv-head{display:grid;grid-template-columns:56px repeat(7,1fr);border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface);z-index:5}
.wv-corner{padding:10px 8px;border-right:1px solid var(--border);background:var(--surface2)}
.wv-dh{text-align:center;padding:10px 4px;border-right:1px solid var(--border);cursor:pointer;transition:background .1s;font-size:12px}
.wv-dh:hover{background:var(--surface2)}
.wv-dh.today{color:var(--accent)}
.wv-dh.today .wv-dn{background:var(--accent);color:#fff;border-radius:50%;width:24px;height:24px;display:inline-flex;align-items:center;justify-content:center}
.wv-dh.sel-day{background:var(--accent-l)}
.wv-dn{display:block;font-size:15px;font-weight:700;margin-bottom:1px}
.wv-dw{font-size:10px;color:var(--muted);font-weight:500}
.wv-allday{display:grid;grid-template-columns:56px repeat(7,1fr);border-bottom:2px solid var(--border);background:var(--surface2)}
.wv-al-lbl{padding:6px 8px;font-size:10px;font-weight:700;color:var(--muted);border-right:1px solid var(--border);display:flex;align-items:center;justify-content:flex-end}
.wv-al-cell{border-right:1px solid var(--border);padding:3px;min-height:28px;display:flex;flex-direction:column;gap:2px}
.wv-body{display:grid;grid-template-columns:56px repeat(7,1fr)}
.wv-time{padding:0 6px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);font-size:10px;color:var(--muted);height:44px;display:flex;align-items:flex-start;padding-top:3px;justify-content:flex-end;background:var(--surface)}
.wv-cell{border-right:1px solid var(--border);border-bottom:1px solid var(--border);height:44px;position:relative;cursor:pointer;transition:background .1s}
.wv-cell:hover{background:var(--surface2)}
.wv-evt{font-size:10px;padding:2px 4px;border-radius:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer;position:absolute;left:2px;right:2px;z-index:2;top:2px}

/* â”€â”€ Projects â”€â”€ */
.proj-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px}
.proj-card{background:var(--surface);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;cursor:pointer;transition:all .2s}
.proj-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.pc-body{padding:20px}
.pc-title{font-size:16px;font-weight:700}
.pc-desc{font-size:13px;color:var(--muted);margin-top:6px}
.pc-bar{height:4px;background:var(--border);margin:14px 0 4px;border-radius:2px;overflow:hidden}
.pc-fill{height:100%;background:var(--green);border-radius:2px;transition:width .5s}
.pc-stats{display:flex;gap:16px;font-size:11px;color:var(--muted)}
.pc-foot{padding:12px 20px;background:var(--surface2);display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--muted)}

/* â”€â”€ Tags â”€â”€ */
.tag{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:500}
.tag-b{background:var(--accent-l);color:var(--accent)}
.tag-g{background:var(--green-l);color:var(--green)}
.tag-a{background:var(--warn-l);color:var(--warn)}
.tag-r{background:var(--red-l);color:var(--red)}
.tag-p{background:var(--purple-l);color:var(--purple)}

/* â”€â”€ Modals â”€â”€ */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.mo.open{display:flex;animation:fadeIn .2s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal{background:var(--surface);border-radius:var(--r);width:100%;max-width:760px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.15);animation:slideUp .25s}
.mh{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between}
.mb{overflow-y:auto;flex:1}
.m-tabs{display:flex;border-bottom:1px solid var(--border);padding:0 24px;overflow-x:auto}
.m-tab{padding:12px 16px;font-size:13px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;margin-bottom:-1px;font-weight:500;transition:all .15s;white-space:nowrap}
.m-tab:hover{color:var(--text)}
.m-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.m-tc{padding:20px 24px;display:none}
.m-tc.active{display:block}

/* â”€â”€ Tasks & Events â”€â”€ */
.tasks-layout{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
.task-item{display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
.task-item:last-child{border-bottom:none}
.t-check{width:18px;height:18px;border:2px solid var(--border);border-radius:4px;flex-shrink:0;cursor:pointer;margin-top:1px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.t-check.done{background:var(--green);border-color:var(--green)}
.t-check.done::after{content:'âœ“';color:#fff;font-size:11px;font-weight:700}
.t-body{flex:1}
.t-title{font-size:13px;font-weight:500}
.t-title.done{text-decoration:line-through;color:var(--muted)}
.t-meta{font-size:11px;color:var(--muted);margin-top:3px;display:flex;gap:10px;flex-wrap:wrap}
.rec-card{background:var(--surface);border-radius:var(--r);box-shadow:var(--shadow);padding:14px 18px;display:flex;align-items:flex-start;gap:14px;cursor:pointer;transition:all .15s}
.rec-card:hover{transform:translateY(-1px);box-shadow:var(--shadow-md)}
.rec-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.ic-daily{background:var(--accent-l)}
.ic-weekly{background:var(--green-l)}
.ic-monthly{background:var(--warn-l)}
.ic-adhoc{background:var(--purple-l)}
.rec-info{flex:1}
.rec-title{font-size:14px;font-weight:600}
.rec-meta{font-size:12px;color:var(--muted);margin-top:3px}
.rec-repeat{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.rep-chip{display:inline-flex;align-items:center;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;background:var(--accent-l);color:var(--accent)}
.rep-chip.monthly{background:var(--warn-l);color:var(--warn)}

/* â”€â”€ Day/Date selectors â”€â”€ */
.repeat-extra{display:none;margin-top:14px;padding:14px;background:var(--surface2);border-radius:var(--rs)}
.repeat-extra.show{display:block}
.re-label{font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:10px}
.day-sel{display:flex;gap:6px;flex-wrap:wrap}
.day-btn{width:38px;height:38px;border-radius:50%;border:1.5px solid var(--border);background:var(--surface);font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;color:var(--muted)}
.day-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-l)}
.day-btn.sel{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 2px 8px rgba(37,99,235,.3)}
.date-sel{display:flex;flex-wrap:wrap;gap:5px}
.date-btn{width:32px;height:32px;border-radius:6px;border:1px solid var(--border);background:var(--surface);font-size:11px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;color:var(--muted)}
.date-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-l)}
.date-btn.sel{background:var(--accent);border-color:var(--accent);color:#fff}

/* â”€â”€ Forms â”€â”€ */
.fg{margin-bottom:16px}
.fl{display:block;font-size:12px;font-weight:600;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.4px}
.fi,.fs,.fta{width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--rs);font-family:inherit;font-size:14px;color:var(--text);background:var(--surface);outline:none;transition:border-color .15s,box-shadow .15s}
.fi:focus,.fs:focus,.fta:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.fta{resize:vertical;min-height:80px}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fa{display:flex;justify-content:flex-end;gap:8px;padding-top:8px;border-top:1px solid var(--border);margin-top:16px}

/* â”€â”€ Alarm â”€â”€ */
.alarm-box{background:var(--warn-l);border:1px solid #FCD34D;border-radius:var(--rs);padding:12px 14px}
.alarm-opts{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.alarm-opt{display:flex;align-items:center;gap:6px;padding:6px 12px;border:1px solid var(--border);border-radius:20px;cursor:pointer;font-size:12px;transition:all .15s;background:#fff}
.alarm-opt:hover{border-color:var(--warn);background:var(--warn-l)}
.alarm-opt.sel{border-color:var(--warn);background:var(--warn-l);color:var(--warn);font-weight:600}

/* â”€â”€ Notes â”€â”€ */
.notes-toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;gap:12px;flex-wrap:wrap}
.notes-filter{display:flex;gap:6px;flex-wrap:wrap}
.f-btn{padding:5px 14px;border-radius:20px;border:1px solid var(--border);background:var(--surface);font-size:12px;font-weight:500;cursor:pointer;transition:all .15s;color:var(--muted)}
.f-btn:hover{border-color:var(--accent);color:var(--accent)}
.f-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
.notes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.note-card{background:var(--surface);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;cursor:pointer;transition:all .2s;border-top:4px solid var(--warn);display:flex;flex-direction:column}
.note-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.nc-yellow{border-top-color:var(--warn)}.nc-blue{border-top-color:var(--accent)}.nc-green{border-top-color:var(--green)}.nc-red{border-top-color:var(--red)}.nc-purple{border-top-color:var(--purple)}
.nc-body{padding:16px;flex:1}
.nc-title{font-size:15px;font-weight:700;margin-bottom:8px}
.nc-preview{font-size:13px;color:var(--muted);line-height:1.6;overflow:hidden;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical}
.nc-foot{padding:10px 16px;background:var(--surface2);display:flex;align-items:center;justify-content:space-between;gap:6px;flex-wrap:wrap;font-size:11px;color:var(--muted)}
.link-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:500;cursor:pointer;transition:all .15s;text-decoration:none;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lb-proj{background:var(--green-l);color:var(--green)}.lb-proj:hover{background:var(--green);color:#fff}
.lb-task{background:var(--purple-l);color:var(--purple)}.lb-task:hover{background:var(--purple);color:#fff}
.linked-note{display:flex;align-items:flex-start;gap:10px;background:var(--warn-l);border-left:3px solid var(--warn);border-radius:0 var(--rs) var(--rs) 0;padding:10px 12px;margin-bottom:8px;cursor:pointer;transition:all .15s}
.linked-note:hover{transform:translateX(2px);box-shadow:var(--shadow)}
.ln-title{font-size:13px;font-weight:600}
.ln-preview{font-size:12px;color:var(--muted);margin-top:3px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;max-width:320px}
.note-item{background:var(--warn-l);border-left:3px solid var(--warn);border-radius:0 var(--rs) var(--rs) 0;padding:12px 14px;margin-bottom:10px;font-size:13px;line-height:1.6}
.meeting-item{border:1px solid var(--border);border-radius:var(--rs);padding:12px 14px;margin-bottom:8px}

/* â”€â”€ Utils â”€â”€ */
.empty{text-align:center;padding:48px 24px;color:var(--muted)}
.empty .ei{font-size:40px;margin-bottom:12px}
.sec-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.sec-title{font-size:16px;font-weight:700}
.divider{height:1px;background:var(--border);margin:20px 0}
.toast{position:fixed;bottom:24px;right:24px;background:#1C1917;color:#fff;padding:12px 20px;border-radius:var(--rs);font-size:13px;z-index:9999;animation:slideUp .3s,fadeOut .3s 2.7s forwards;box-shadow:var(--shadow-md)}
@keyframes fadeOut{to{opacity:0;transform:translateY(10px)}}
.hbg{display:none;background:none;border:none;cursor:pointer;padding:4px;color:var(--text)}

/* â”€â”€ Responsive â”€â”€ */
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .main{margin-left:0}.hbg{display:block}
  .cal-layout,.fr,.proj-grid,.tasks-layout{grid-template-columns:1fr}
  .page{padding:16px}.topbar{padding:12px 16px}
  .alarm-panel{right:8px;width:calc(100vw - 16px)}
  .notes-grid{grid-template-columns:1fr}
  
  /* ğŸ“± ìº˜ë¦°ë” ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ ìµœì í™” */
  .cal-card { overflow-x: auto; }
  .cal-grid { min-width: 600px; }
  .week-view { overflow-x: auto; }
  .wv-head, .wv-allday, .wv-body { min-width: 600px; }
}
</style>
</head>
<body>

<!-- â”€â”€ Auth Login Overlay â”€â”€ -->
<div id="authOverlay" class="auth-overlay">
  <div class="auth-box">
    <div class="auth-title">í”Œë¡œìš°</div>
    <div class="auth-sub">ë¡œê·¸ì¸í•˜ì—¬ ë‚˜ë§Œì˜ ì¼ì •ì„ ê´€ë¦¬í•˜ì„¸ìš”</div>
    <div class="fg" style="text-align:left;"><label class="fl">ì´ë©”ì¼</label><input class="fi" type="email" id="authEmail" placeholder="name@example.com"></div>
    <div class="fg" style="text-align:left;"><label class="fl">ë¹„ë°€ë²ˆí˜¸</label><input class="fi" type="password" id="authPwd" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeyup="if(event.key==='Enter') handleLogin()"></div>
    <div id="authError" style="color:var(--red); font-size:12px; margin-bottom:16px; min-height:14px; word-break: keep-all;"></div>
    <div style="display:flex; gap:10px;">
      <button class="btn btn-s" style="flex:1; justify-content:center;" onclick="handleSignUp()">íšŒì›ê°€ì…</button>
      <button class="btn btn-p" style="flex:1; justify-content:center;" onclick="handleLogin()">ë¡œê·¸ì¸</button>
    </div>
  </div>
</div>

<div class="shell">

<!-- â”€â”€ Sidebar â”€â”€ -->
<aside class="sidebar" id="sidebar">
  <div class="logo">í”Œë¡œìš°<span>ì¼ì • ë° í”„ë¡œì íŠ¸ ê´€ë¦¬</span></div>
  <div class="nav-sec">
    <div class="nav-lbl">ë©”ì¸</div>
    <div class="nav-item active" onclick="showPage('calendar')">
      <svg class="ni" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" stroke-width="2"/><line x1="16" y1="2" x2="16" y2="6" stroke-width="2"/><line x1="8" y1="2" x2="8" y2="6" stroke-width="2"/><line x1="3" y1="10" x2="21" y2="10" stroke-width="2"/></svg>ìº˜ë¦°ë”
    </div>
    <div class="nav-item" onclick="showPage('projects')">
      <svg class="ni" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>í”„ë¡œì íŠ¸
    </div>
    <div class="nav-item" onclick="showPage('tasks')">
      <svg class="ni" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4" stroke-width="2"/><path stroke-width="2" d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>ì—…ë¬´ ê´€ë¦¬
    </div>
    <div class="nav-item" onclick="showPage('notes')">
      <svg class="ni" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8" stroke-width="2"/><line x1="16" y1="13" x2="8" y2="13" stroke-width="2"/><line x1="16" y1="17" x2="8" y2="17" stroke-width="2"/></svg>ë…¸íŠ¸
    </div>
  </div>
  
  <!-- ê³„ì • ì •ë³´ ë° ë¡œê·¸ì•„ì›ƒ ìœ„ì¹˜ -->
  <div style="margin-top:auto;padding:16px;border-top:1px solid var(--border)">
    <div id="userInfoDisplay" style="font-size:12px; font-weight:700; color:var(--accent); margin-bottom:10px; text-align:center; word-break:break-all;"></div>
    <button class="btn btn-s btn-sm" style="width:100%; justify-content:center; margin-bottom:12px;" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    <div id="alarmSidebarStatus" style="font-size:11px;color:var(--muted);text-align:center"></div>
  </div>
</aside>

<!-- â”€â”€ Main â”€â”€ -->
<div class="main">
  <header class="topbar">
    <div class="tb-l">
      <button class="hbg" onclick="toggleSidebar()">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12" stroke-width="2"/><line x1="3" y1="6" x2="21" y2="6" stroke-width="2"/><line x1="3" y1="18" x2="21" y2="18" stroke-width="2"/></svg>
      </button>
      <div><div class="tb-title" id="pageTitle">ìº˜ë¦°ë”</div><div class="tb-sub" id="pageSub">ì¼ì •ì„ í™•ì¸í•˜ê³  ì¶”ê°€í•˜ì„¸ìš”</div></div>
    </div>
    <button class="bell-btn" onclick="toggleAlarmPanel()">ğŸ””<span class="alarm-badge" id="alarmBadge" style="display:none">0</span></button>
  </header>

  <div class="alarm-panel" id="alarmPanel">
    <div class="ap-head"><span>ğŸ”” ì˜ˆì •ëœ ì•ŒëŒ</span><button class="btn btn-s btn-sm" onclick="dismissAllAlarms()">ëª¨ë‘ ì§€ìš°ê¸°</button></div>
    <div class="ap-body" id="alarmPanelBody"><div class="empty" style="padding:24px"><div class="ei">ğŸ”•</div><p>ì˜ˆì •ëœ ì•ŒëŒ ì—†ìŒ</p></div></div>
  </div>

  <!-- ìº˜ë¦°ë” -->
  <div class="page active" id="page-calendar">
    <div id="setupNotice" class="banner-warn" style="display:none">
      <span style="font-size:20px">âš ï¸</span>
      <div><strong style="color:#92400E">Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤!</strong><p style="color:#78350F;margin-top:4px">ì½”ë“œ ìƒë‹¨ì˜ firebaseConfigì— Firebase ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ ëª¨ë“  ê¸°ê¸°ì—ì„œ ë™ê¸°í™”ë©ë‹ˆë‹¤.</p></div>
    </div>
    <div id="notifBanner" class="banner-info" style="display:none">
      <span style="font-size:20px">ğŸ””</span>
      <div><strong style="color:#1E40AF">ì•ŒëŒ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</strong>
      <p style="color:#1D4ED8;margin-top:2px;font-size:12px">ë¸Œë¼ìš°ì € ì•Œë¦¼ì„ í—ˆìš©í•˜ë©´ ì¼ì • ì‹œê°„ì— ìë™ìœ¼ë¡œ ì•ŒëŒì´ ìš¸ë¦½ë‹ˆë‹¤. &nbsp;
      <button class="btn btn-p btn-sm" onclick="requestNotifPermission()">ì•Œë¦¼ í—ˆìš©í•˜ê¸°</button></p></div>
    </div>

    <!-- íˆ´ë°”: ì›”/ì£¼ í† ê¸€ + ë‚ ì§œ ì´ë™ -->
    <div class="cal-toolbar">
      <div class="cal-toolbar-l">
        <button class="btn btn-ic btn-sm" onclick="changeView(-1)">â€¹</button>
        <button class="btn btn-s btn-sm" onclick="goToday()">ì˜¤ëŠ˜</button>
        <button class="btn btn-ic btn-sm" onclick="changeView(1)">â€º</button>
        <div class="cal-month" id="calTitle" style="font-size:16px;font-weight:700;margin-left:4px"></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="view-toggle">
          <button class="vt-btn active" id="vt-month" onclick="setView('month')">ì›”ê°„</button>
          <button class="vt-btn" id="vt-week" onclick="setView('week')">ì£¼ê°„</button>
        </div>
        <button class="btn btn-p btn-sm" onclick="openAddEvent()">+ ì¼ì • ì¶”ê°€</button>
      </div>
    </div>

    <!-- ì›”ê°„ ë·° -->
    <div id="monthView">
      <div class="cal-layout">
        <div class="cal-card">
          <div class="cal-grid" id="calGrid"></div>
        </div>
        <div>
          <div class="side-panel">
            <div class="sp-head">
              <div class="sp-title" id="selDateTitle">ì˜¤ëŠ˜ ì¼ì •</div>
            </div>
            <div class="sp-body"><div class="evt-list" id="dayEvtList"><div class="empty"><div class="ei">ğŸ“…</div><p>ì´ ë‚ ì˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</p></div></div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ì£¼ê°„ ë·° -->
    <div id="weekView" style="display:none">
      <div class="week-view" id="weekGrid"></div>
    </div>
  </div>

  <!-- í”„ë¡œì íŠ¸ -->
  <div class="page" id="page-projects">
    <div class="sec-head"><div class="sec-title">í”„ë¡œì íŠ¸ ëª©ë¡</div><button class="btn btn-p" onclick="openAddProject()">+ ìƒˆ í”„ë¡œì íŠ¸</button></div>
    <div class="proj-grid" id="projGrid"><div class="empty" style="grid-column:1/-1"><div class="ei">ğŸ“</div><p>í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p></div></div>
  </div>

  <!-- ì—…ë¬´ ê´€ë¦¬ -->
  <div class="page" id="page-tasks">
    <div class="sec-head"><div class="sec-title">ì—…ë¬´ ê´€ë¦¬</div><button class="btn btn-p" onclick="openAddTask()">+ ìƒˆ ì—…ë¬´</button></div>
    <div class="tasks-layout">
      <div>
        <div style="font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">ğŸ” ë°˜ë³µ ì—…ë¬´</div>
        <div id="recurringList" style="display:flex;flex-direction:column;gap:8px"><div class="empty"><div class="ei">ğŸ”</div><p>ë°˜ë³µ ì—…ë¬´ ì—†ìŒ</p></div></div>
      </div>
      <div>
        <div style="font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">âš¡ ìˆ˜ì‹œ ì—…ë¬´</div>
        <div id="adHocList" style="display:flex;flex-direction:column;gap:8px"><div class="empty"><div class="ei">âš¡</div><p>ìˆ˜ì‹œ ì—…ë¬´ ì—†ìŒ</p></div></div>
      </div>
    </div>
    <div class="divider"></div>
    <div style="font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">âœ… ì „ì²´ ì—…ë¬´ í˜„í™©</div>
    <div id="allTasksList" style="background:var(--surface);border-radius:var(--r);box-shadow:var(--shadow);padding:4px 20px"><div class="empty"><div class="ei">âœ…</div><p>ì—…ë¬´ ì—†ìŒ</p></div></div>
  </div>

  <!-- ë…¸íŠ¸ -->
  <div class="page" id="page-notes">
    <div class="notes-toolbar">
      <div class="notes-filter">
        <button class="f-btn active" onclick="setNoteFilter('all',this)">ì „ì²´</button>
        <button class="f-btn" onclick="setNoteFilter('none',this)">ì—°ê²° ì—†ìŒ</button>
        <button class="f-btn" onclick="setNoteFilter('project',this)">ğŸ“ í”„ë¡œì íŠ¸ ì—°ê²°</button>
        <button class="f-btn" onclick="setNoteFilter('task',this)">âœ… ì—…ë¬´ ì—°ê²°</button>
      </div>
      <button class="btn btn-p" onclick="openNoteModal()">+ ìƒˆ ë…¸íŠ¸</button>
    </div>
    <div class="notes-grid" id="notesGrid"><div class="empty" style="grid-column:1/-1"><div class="ei">ğŸ“</div><p>ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p></div></div>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Event Add/Edit Modal -->
<div class="mo" id="moAddEvent">
  <div class="modal" style="max-width:520px">
    <div class="mh">
      <div><div style="font-size:16px;font-weight:700" id="evtModalTitle">ì¼ì • ì¶”ê°€</div><div style="font-size:12px;color:var(--muted);margin-top:2px" id="evtDateLabel"></div></div>
      <button class="btn btn-ic btn-sm" onclick="closeModal('moAddEvent')">âœ•</button>
    </div>
    <div style="padding:20px 24px;overflow-y:auto;max-height:calc(90vh - 80px)">
      <div class="fg">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
          <label class="fl" style="margin-bottom:0;">ì œëª©</label>
          <div style="display:flex; gap:4px;">
            <button class="prefix-btn" onclick="addPrefix('evtTitle', '[ì—…ë¬´]')">ì—…ë¬´</button>
            <button class="prefix-btn" onclick="addPrefix('evtTitle', '[ìˆ˜ì‹œ]')">ìˆ˜ì‹œ</button>
            <button class="prefix-btn" onclick="addPrefix('evtTitle', '[í”„ë¡œì íŠ¸]')">í”„ë¡œì íŠ¸</button>
            <button class="prefix-btn" onclick="addPrefix('evtTitle', '[ì¼ìƒ]')">ì¼ìƒ</button>
            <button class="prefix-btn urg" onclick="addPrefix('evtTitle', '[ê¸´ê¸‰]')">ê¸´ê¸‰</button>
          </div>
        </div>
        <input class="fi" id="evtTitle" placeholder="ì¼ì • ì œëª©">
      </div>
      <div class="fr">
        <div class="fg"><label class="fl">ë‚ ì§œ / ì‹œì‘ì¼</label><input class="fi" type="date" id="evtDate"></div>
        <div class="fg">
          <label class="fl">ì‹œê°„</label>
          <div style="display:flex; align-items:center; gap:6px;">
            <input class="fi" type="time" id="evtStartTime" style="flex:1;">
            <span style="color:var(--muted); font-weight:600;">~</span>
            <input class="fi" type="time" id="evtEndTime" style="flex:1;">
          </div>
        </div>
      </div>
      
      <!-- ì¼ì • ë°˜ë³µ ì„¤ì • -->
      <div class="fr">
        <div class="fg"><label class="fl">ë°˜ë³µ ì„¤ì •</label>
          <select class="fs" id="evtRepeatType" onchange="onEvtRepeatChange(this.value)">
            <option value="none">ë°˜ë³µ ì—†ìŒ</option>
            <option value="daily">ğŸ” ë§¤ì¼</option>
            <option value="weekly">ğŸ” ë§¤ì£¼</option>
            <option value="monthly">ğŸ” ë§¤ì›”</option>
          </select>
        </div>
        <div class="fg"><label class="fl">ìœ í˜•</label>
          <select class="fs" id="evtType">
            <option value="meeting">ğŸ“‹ íšŒì˜</option><option value="task">âœ… ì—…ë¬´</option>
            <option value="deadline">ğŸ”´ ë§ˆê°ì¼</option><option value="reminder">ğŸ”” ë¦¬ë§ˆì¸ë”</option>
          </select>
        </div>
      </div>
      
      <!-- ì¼ì • ë°˜ë³µ ì„¸ë¶€ ìš”ì¼/ë‚ ì§œ í”½ì»¤ -->
      <div class="repeat-extra" id="evtWeeklyPicker">
        <div class="re-label">ë°˜ë³µ ìš”ì¼ <span style="font-weight:400;text-transform:none">(ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</span></div>
        <div class="day-sel">
          <button type="button" class="evt-day-btn day-btn" data-d="0" onclick="this.classList.toggle('sel')">ì¼</button>
          <button type="button" class="evt-day-btn day-btn" data-d="1" onclick="this.classList.toggle('sel')">ì›”</button>
          <button type="button" class="evt-day-btn day-btn" data-d="2" onclick="this.classList.toggle('sel')">í™”</button>
          <button type="button" class="evt-day-btn day-btn" data-d="3" onclick="this.classList.toggle('sel')">ìˆ˜</button>
          <button type="button" class="evt-day-btn day-btn" data-d="4" onclick="this.classList.toggle('sel')">ëª©</button>
          <button type="button" class="evt-day-btn day-btn" data-d="5" onclick="this.classList.toggle('sel')">ê¸ˆ</button>
          <button type="button" class="evt-day-btn day-btn" data-d="6" onclick="this.classList.toggle('sel')">í† </button>
        </div>
      </div>
      <div class="repeat-extra" id="evtMonthlyPicker">
        <div class="re-label">ë°˜ë³µ ë‚ ì§œ <span style="font-weight:400;text-transform:none">(ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</span></div>
        <div class="date-sel" id="evtMonthlyDates"></div>
        <div style="font-size:11px;color:var(--muted);margin-top:6px">â€» 29~31ì¼ì€ í•´ë‹¹ ì›”ì— ì—†ì„ ê²½ìš° ê±´ë„ˆëœë‹ˆë‹¤</div>
      </div>
      
      <div class="fg"><label class="fl">í”„ë¡œì íŠ¸ ì—°ê²°</label><select class="fs" id="evtProject"><option value="">ì—†ìŒ</option></select></div>
      
      <!-- ì™„ë£Œ ì²´í¬ë°•ìŠ¤ -->
      <div class="fg" style="display:flex; align-items:center; gap:8px; padding: 8px 12px; background:var(--surface2); border-radius:var(--rs);">
        <div class="t-check" id="evtDoneCheck" onclick="this.classList.toggle('done')"></div>
        <label style="font-size:13px; font-weight:600; cursor:pointer; color:var(--text); margin:0;" onclick="$('evtDoneCheck').classList.toggle('done')">ì´ ì¼ì • ì™„ë£Œí•˜ê¸° <span id="evtDoneDateHint" style="color:var(--accent);font-weight:400;font-size:11px;margin-left:4px"></span></label>
      </div>

      <div class="fg"><label class="fl">ë©”ëª¨</label><textarea class="fta" id="evtNote" placeholder="ì¶”ê°€ ë‚´ìš© (ì„ íƒ)"></textarea></div>
      <div class="alarm-box">
        <label class="fl" style="color:var(--warn)">ğŸ”” ì•ŒëŒ ì„¤ì •</label>
        <div style="font-size:12px;color:var(--muted)">ì•ŒëŒ ì‹œì  ì„ íƒ (ì‹œì‘ ì‹œê°„ ê¸°ì¤€, ë³µìˆ˜ ê°€ëŠ¥)</div>
        <div class="alarm-opts">
          <label class="alarm-opt"><input type="checkbox" value="0" onchange="toggleAlarmOpt(this)"> ì •ì‹œ</label>
          <label class="alarm-opt"><input type="checkbox" value="5" onchange="toggleAlarmOpt(this)"> 5ë¶„ ì „</label>
          <label class="alarm-opt"><input type="checkbox" value="10" onchange="toggleAlarmOpt(this)"> 10ë¶„ ì „</label>
          <label class="alarm-opt"><input type="checkbox" value="30" onchange="toggleAlarmOpt(this)"> 30ë¶„ ì „</label>
          <label class="alarm-opt"><input type="checkbox" value="60" onchange="toggleAlarmOpt(this)"> 1ì‹œê°„ ì „</label>
          <label class="alarm-opt"><input type="checkbox" value="1440" onchange="toggleAlarmOpt(this)"> í•˜ë£¨ ì „</label>
        </div>
      </div>
      <input type="hidden" id="evtEditId">
      <div class="fa">
        <button class="btn btn-d btn-sm" id="evtDelBtn" style="display:none;margin-right:auto" onclick="deleteEventFromModal()">ğŸ—‘ ì‚­ì œ</button>
        <button class="btn btn-s" onclick="closeModal('moAddEvent')">ì·¨ì†Œ</button>
        <button class="btn btn-p" onclick="saveEvent()">ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Project Modal -->
<div class="mo" id="moAddProject">
  <div class="modal" style="max-width:480px">
    <div class="mh"><div style="font-size:16px;font-weight:700" id="projModalTitle">ìƒˆ í”„ë¡œì íŠ¸</div><button class="btn btn-ic btn-sm" onclick="closeModal('moAddProject')">âœ•</button></div>
    <div style="padding:20px 24px">
      <div class="fg"><label class="fl">í”„ë¡œì íŠ¸ëª…</label><input class="fi" id="projName" placeholder="í”„ë¡œì íŠ¸ ì´ë¦„"></div>
      <div class="fg"><label class="fl">ì„¤ëª…</label><textarea class="fta" id="projDesc" placeholder="ì„¤ëª… (ì„ íƒ)" style="min-height:60px"></textarea></div>
      <div class="fr">
        <div class="fg"><label class="fl">ì‹œì‘ì¼</label><input class="fi" type="date" id="projStart"></div>
        <div class="fg"><label class="fl">ì¢…ë£Œì¼</label><input class="fi" type="date" id="projEnd"></div>
      </div>
      <div class="fg"><label class="fl">ìƒíƒœ</label>
        <select class="fs" id="projStatus">
          <option value="active">ì§„í–‰ì¤‘</option><option value="planning">ê³„íšì¤‘</option>
          <option value="completed">ì™„ë£Œ</option><option value="hold">ë³´ë¥˜</option>
        </select>
      </div>
      <input type="hidden" id="projEditId">
      <div class="fa">
        <button class="btn btn-d btn-sm" id="projDelBtn" style="display:none;margin-right:auto" onclick="deleteProject()">ğŸ—‘ ì‚­ì œ</button>
        <button class="btn btn-s" onclick="closeModal('moAddProject')">ì·¨ì†Œ</button>
        <button class="btn btn-p" onclick="saveProject()">ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

<!-- Project Detail Modal -->
<div class="mo" id="moProjDetail">
  <div class="modal">
    <div class="mh">
      <div>
        <div style="display:flex;align-items:center;gap:8px"><div style="font-size:18px;font-weight:700" id="dpTitle"></div><span id="dpStatus"></span></div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px" id="dpDates"></div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-s btn-sm" onclick="openEditProject()">âœï¸ ìˆ˜ì •</button>
        <button class="btn btn-ic btn-sm" onclick="closeModal('moProjDetail')">âœ•</button>
      </div>
    </div>
    <div class="m-tabs">
      <div class="m-tab active" onclick="switchProjTab('subtasks')">ì„¸ë¶€ ì—…ë¬´</div>
      <div class="m-tab" onclick="switchProjTab('meetings')">íšŒì˜ë¡</div>
      <div class="m-tab" onclick="switchProjTab('notes')">ë©”ëª¨</div>
      <div class="m-tab" onclick="switchProjTab('linkednotes')">ğŸ“ ì—°ê²° ë…¸íŠ¸</div>
    </div>
    <div class="mb">
      <div class="m-tc active" id="pt-subtasks">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <div style="font-size:13px;font-weight:600" id="stStats"></div>
          <button class="btn btn-p btn-sm" onclick="openAddSubtask()">+ ì„¸ë¶€ ì—…ë¬´ ì¶”ê°€</button>
        </div>
        <div id="subtaskList"></div>
        <div id="addStForm" style="display:none;background:var(--surface2);border-radius:var(--rs);padding:16px;margin-top:12px">
          <div class="fr"><div class="fg" style="margin-bottom:10px"><label class="fl">ì—…ë¬´ëª…</label><input class="fi" id="stTitle" placeholder="ì—…ë¬´ ì œëª©"></div>
          <div class="fg" style="margin-bottom:10px"><label class="fl">ë‹´ë‹¹ì</label><input class="fi" id="stAssignee" placeholder="ë‹´ë‹¹ì (ì„ íƒ)"></div></div>
          <div class="fr"><div class="fg" style="margin-bottom:10px"><label class="fl">ì‹œì‘ì¼</label><input class="fi" type="date" id="stStart"></div>
          <div class="fg" style="margin-bottom:10px"><label class="fl">ë§ˆê°ì¼</label><input class="fi" type="date" id="stDue"></div></div>
          <div class="fg" style="margin-bottom:10px"><label class="fl">ìš°ì„ ìˆœìœ„</label><select class="fs" id="stPriority"><option value="medium">ë³´í†µ</option><option value="high">ë†’ìŒ</option><option value="low">ë‚®ìŒ</option></select></div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn btn-s btn-sm" onclick="$('addStForm').style.display='none'">ì·¨ì†Œ</button>
            <button class="btn btn-p btn-sm" onclick="saveSubtask()">ì €ì¥</button>
          </div>
        </div>
      </div>
      <div class="m-tc" id="pt-meetings">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <div style="font-size:13px;font-weight:600">íšŒì˜ ê¸°ë¡</div>
          <button class="btn btn-p btn-sm" onclick="openAddMeeting()">+ íšŒì˜ ì¶”ê°€</button>
        </div>
        <div id="meetingList"></div>
        <div id="addMtForm" style="display:none;background:var(--surface2);border-radius:var(--rs);padding:16px;margin-top:12px">
          <div class="fr">
            <div class="fg" style="margin-bottom:10px"><label class="fl">íšŒì˜ ì œëª©</label><input class="fi" id="mtTitle" placeholder="íšŒì˜ ì œëª©"></div>
            <div class="fg" style="margin-bottom:10px"><label class="fl">ì°¸ì„ì</label><input class="fi" id="mtAttendees" placeholder="ì°¸ì„ì (ì‰¼í‘œë¡œ êµ¬ë¶„)"></div>
          </div>
          <div class="fr">
            <div class="fg" style="margin-bottom:10px"><label class="fl">ë‚ ì§œ</label><input class="fi" type="date" id="mtDate"></div>
            <div class="fg" style="margin-bottom:10px"><label class="fl">ì‹œê°„</label><input class="fi" type="time" id="mtTime"></div>
          </div>
          <div class="fg" style="margin-bottom:10px"><label class="fl">íšŒì˜ ë‚´ìš©/ê²°ì •ì‚¬í•­</label><textarea class="fta" id="mtNotes" placeholder="íšŒì˜ ë‚´ìš©, ê²°ì •ì‚¬í•­, ì•¡ì…˜ ì•„ì´í…œ"></textarea></div>
          <label style="font-size:12px;display:flex;align-items:center;gap:6px;margin-bottom:16px;color:var(--accent)"><input type="checkbox" id="mtSyncCal" checked> ìº˜ë¦°ë” ì¼ì •ì— ìë™ìœ¼ë¡œ ë“±ë¡í•˜ê¸°</label>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn btn-s btn-sm" onclick="$('addMtForm').style.display='none'">ì·¨ì†Œ</button>
            <button class="btn btn-p btn-sm" onclick="saveMeeting()">ì €ì¥</button>
          </div>
        </div>
      </div>
      <div class="m-tc" id="pt-notes">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <div style="font-size:13px;font-weight:600">í”„ë¡œì íŠ¸ ë©”ëª¨</div>
          <button class="btn btn-p btn-sm" onclick="openAddProjNote()">+ ë©”ëª¨ ì¶”ê°€</button>
        </div>
        <div id="projNoteList"></div>
        <div id="addPnForm" style="display:none;background:var(--surface2);border-radius:var(--rs);padding:16px;margin-top:12px">
          <div class="fg" style="margin-bottom:10px"><label class="fl">ì œëª©</label><input class="fi" id="pnTitle" placeholder="ì œëª© (ì„ íƒ)"></div>
          <div class="fg" style="margin-bottom:10px"><label class="fl">ë‚´ìš©</label><textarea class="fta" id="pnContent" placeholder="ë©”ëª¨ ë‚´ìš©" style="min-height:120px"></textarea></div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn btn-s btn-sm" onclick="$('addPnForm').style.display='none'">ì·¨ì†Œ</button>
            <button class="btn btn-p btn-sm" onclick="saveProjNote()">ì €ì¥</button>
          </div>
        </div>
      </div>
      <div class="m-tc" id="pt-linkednotes"><div id="linkedNotesArea"></div></div>
    </div>
  </div>
</div>

<!-- Add/Edit Task Modal -->
<div class="mo" id="moAddTask">
  <div class="modal" style="max-width:520px">
    <div class="mh"><div style="font-size:16px;font-weight:700" id="taskModalTitle">ì—…ë¬´ ì¶”ê°€</div><button class="btn btn-ic btn-sm" onclick="closeModal('moAddTask')">âœ•</button></div>
    <div style="padding:20px 24px;overflow-y:auto;max-height:calc(90vh - 80px)">
      <div class="fg">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
          <label class="fl" style="margin-bottom:0;">ì—…ë¬´ëª…</label>
          <div style="display:flex; gap:4px;">
            <button class="prefix-btn" onclick="addPrefix('taskTitle', '[ì—…ë¬´]')">ì—…ë¬´</button>
            <button class="prefix-btn" onclick="addPrefix('taskTitle', '[ìˆ˜ì‹œ]')">ìˆ˜ì‹œ</button>
            <button class="prefix-btn" onclick="addPrefix('taskTitle', '[ë°˜ë³µ]')">ë°˜ë³µ</button>
            <button class="prefix-btn" onclick="addPrefix('taskTitle', '[ì¼ìƒ]')">ì¼ìƒ</button>
            <button class="prefix-btn urg" onclick="addPrefix('taskTitle', '[ê¸´ê¸‰]')">ê¸´ê¸‰</button>
          </div>
        </div>
        <input class="fi" id="taskTitle" placeholder="ì—…ë¬´ ì œëª©">
      </div>
      <div class="fr">
        <div class="fg"><label class="fl">ìœ í˜•</label>
          <select class="fs" id="taskType" onchange="onTaskTypeChange(this.value)">
            <option value="recurring-daily">ğŸ” ë°˜ë³µ - ë§¤ì¼</option>
            <option value="recurring-weekly">ğŸ” ë°˜ë³µ - ë§¤ì£¼</option>
            <option value="recurring-monthly">ğŸ” ë°˜ë³µ - ë§¤ì›”</option>
            <option value="adhoc">âš¡ ìˆ˜ì‹œ ì—…ë¬´</option>
          </select>
        </div>
        <div class="fg"><label class="fl">ìš°ì„ ìˆœìœ„</label>
          <select class="fs" id="taskPriority"><option value="medium">ë³´í†µ</option><option value="high">ë†’ìŒ ğŸ”´</option><option value="low">ë‚®ìŒ ğŸŸ¢</option></select>
        </div>
      </div>
      <!-- ìˆ˜ì‹œ ì—…ë¬´ ëª©í‘œ ì¼ì -->
      <div class="fg" id="taskDateWrap" style="display:none"><label class="fl">ëª©í‘œ ì¼ì</label>
        <input class="fi" type="date" id="taskDate">
      </div>
      <!-- ì‹œê°„ ì„¤ì • (ë°˜ë³µ ì—…ë¬´) -->
      <div class="fg"><label class="fl">ì‹œê°„ <span style="font-weight:400;text-transform:none;font-size:11px">(ìº˜ë¦°ë” í‘œì‹œìš©, ì„ íƒ)</span></label>
        <input class="fi" type="time" id="taskTime" placeholder="ì‹œê°„ ì„ íƒ (ì„ íƒì‚¬í•­)">
      </div>
      <!-- ë§¤ì£¼ ìš”ì¼ ì„ íƒ -->
      <div class="repeat-extra" id="weeklyPicker">
        <div class="re-label">ë°˜ë³µ ìš”ì¼ <span style="font-weight:400;text-transform:none">(ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</span></div>
        <div class="day-sel">
          <button type="button" class="day-btn" data-d="0" onclick="toggleDay(this)">ì¼</button>
          <button type="button" class="day-btn" data-d="1" onclick="toggleDay(this)">ì›”</button>
          <button type="button" class="day-btn" data-d="2" onclick="toggleDay(this)">í™”</button>
          <button type="button" class="day-btn" data-d="3" onclick="toggleDay(this)">ìˆ˜</button>
          <button type="button" class="day-btn" data-d="4" onclick="toggleDay(this)">ëª©</button>
          <button type="button" class="day-btn" data-d="5" onclick="toggleDay(this)">ê¸ˆ</button>
          <button type="button" class="day-btn" data-d="6" onclick="toggleDay(this)">í† </button>
        </div>
      </div>
      <!-- ë§¤ì›” ë‚ ì§œ ì„ íƒ -->
      <div class="repeat-extra" id="monthlyPicker">
        <div class="re-label">ë°˜ë³µ ë‚ ì§œ <span style="font-weight:400;text-transform:none">(ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</span></div>
        <div class="date-sel" id="monthlyDates"></div>
        <div style="font-size:11px;color:var(--muted);margin-top:6px">â€» 29~31ì¼ì€ í•´ë‹¹ ì›”ì— ì—†ì„ ê²½ìš° ê±´ë„ˆëœë‹ˆë‹¤</div>
      </div>
      <div class="fg"><label class="fl">ë‹´ë‹¹ì</label><input class="fi" id="taskAssignee" placeholder="ë‹´ë‹¹ì (ì„ íƒ)"></div>
      <div class="fg"><label class="fl">ì„¤ëª…</label><textarea class="fta" id="taskDesc" placeholder="ì—…ë¬´ ì„¤ëª… (ì„ íƒ)" style="min-height:60px"></textarea></div>
      <input type="hidden" id="taskEditId">
      <div class="fa">
        <button class="btn btn-s" onclick="closeModal('moAddTask')">ì·¨ì†Œ</button>
        <button class="btn btn-p" onclick="saveTask()">ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

<!-- Task Detail Modal -->
<div class="mo" id="moTaskDetail">
  <div class="modal" style="max-width:560px">
    <div class="mh">
      <div>
        <div style="display:flex;align-items:center;gap:8px"><div style="font-size:18px;font-weight:700" id="tdTitle"></div><span id="tdPriorityBadge"></span></div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px" id="tdMeta"></div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-s btn-sm" onclick="openEditTask()">âœï¸ ìˆ˜ì •</button>
        <button class="btn btn-ic btn-sm" onclick="closeModal('moTaskDetail')">âœ•</button>
      </div>
    </div>
    <div class="m-tabs">
      <div class="m-tab active" onclick="switchTaskTab('info')">ì—…ë¬´ ì •ë³´</div>
      <div class="m-tab" onclick="switchTaskTab('notes')">ğŸ“ ì—°ê²° ë…¸íŠ¸</div>
    </div>
    <div class="mb">
      <div class="m-tc active" id="tt-info">
        <div id="tdRepeatInfo" style="margin-bottom:16px"></div>
        <div id="tdDesc" style="font-size:14px;line-height:1.8;color:var(--text)"></div>
        <div style="margin-top:20px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btn-s btn-sm" id="tdDoneBtn" onclick="toggleTaskDoneFromDetail()" style="margin-right:auto">âœ“ ì´ ë‚ ì§œ ì™„ë£Œ ì²˜ë¦¬</button>
          <button class="btn btn-d btn-sm" onclick="deleteTaskFromDetail()">ğŸ—‘ ì‚­ì œ</button>
        </div>
      </div>
      <div class="m-tc" id="tt-notes">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <div style="font-size:13px;font-weight:600" id="tdNoteCount">ì—°ê²°ëœ ë…¸íŠ¸</div>
          <button class="btn btn-p btn-sm" onclick="openNoteFromTask()">+ ë…¸íŠ¸ ì¶”ê°€</button>
        </div>
        <div id="tdLinkedNotes"></div>
      </div>
    </div>
  </div>
</div>

<!-- Note Add/Edit Modal -->
<div class="mo" id="moNote">
  <div class="modal" style="max-width:540px">
    <div class="mh"><div style="font-size:16px;font-weight:700" id="noteMoTitle">ìƒˆ ë…¸íŠ¸</div><button class="btn btn-ic btn-sm" onclick="closeModal('moNote')">âœ•</button></div>
    <div style="padding:20px 24px">
      <div class="fg"><label class="fl">ì œëª©</label><input class="fi" id="noteTitle" placeholder="ë…¸íŠ¸ ì œëª©"></div>
      <div class="fg"><label class="fl">ë‚´ìš©</label><textarea class="fta" id="noteContent" placeholder="ë…¸íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="min-height:140px"></textarea></div>
      <div class="fr">
        <div class="fg"><label class="fl">ìƒ‰ìƒ</label>
          <select class="fs" id="noteColor">
            <option value="yellow">ğŸŸ¡ ë…¸ë‘</option><option value="blue">ğŸ”µ íŒŒë‘</option>
            <option value="green">ğŸŸ¢ ì´ˆë¡</option><option value="red">ğŸ”´ ë¹¨ê°•</option><option value="purple">ğŸŸ£ ë³´ë¼</option>
          </select>
        </div>
        <div class="fg"><label class="fl">ì—°ê²° ëŒ€ìƒ</label>
          <select class="fs" id="noteLinkType" onchange="onNoteLinkChange(this.value)">
            <option value="none">ì—°ê²° ì—†ìŒ</option>
            <option value="project">ğŸ“ í”„ë¡œì íŠ¸ì— ì—°ê²°</option>
            <option value="task">âœ… ì—…ë¬´ì— ì—°ê²°</option>
          </select>
        </div>
      </div>
      <div class="fg" id="noteLinkGroup" style="display:none">
        <label class="fl" id="noteLinkLabel">ì—°ê²°í•  í•­ëª©</label>
        <select class="fs" id="noteLinkTarget"></select>
      </div>
      <input type="hidden" id="noteEditId">
      <div class="fa">
        <button class="btn btn-d btn-sm" id="noteDelBtn" style="display:none;margin-right:auto" onclick="deleteNote()">ì‚­ì œ</button>
        <button class="btn btn-s" onclick="closeModal('moNote')">ì·¨ì†Œ</button>
        <button class="btn btn-p" onclick="saveNote()">ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

<!-- Note Detail Modal -->
<div class="mo" id="moNoteDetail">
  <div class="modal" style="max-width:560px">
    <div class="mh">
      <div>
        <div style="font-size:18px;font-weight:700" id="ndTitle"></div>
        <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap" id="ndLinks"></div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-s btn-sm" onclick="editNoteFromDetail()">âœï¸ ìˆ˜ì •</button>
        <button class="btn btn-ic btn-sm" onclick="closeModal('moNoteDetail')">âœ•</button>
      </div>
    </div>
    <div style="padding:20px 24px;font-size:14px;line-height:1.9;white-space:pre-wrap;min-height:100px;max-height:55vh;overflow-y:auto" id="ndContent"></div>
    <div style="padding:12px 24px;border-top:1px solid var(--border);font-size:11px;color:var(--muted)" id="ndMeta"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);
const fmtDate = d => d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
function openModal(id){ $(id).classList.add('open') }
function closeModal(id){ $(id).classList.remove('open') }
document.querySelectorAll('.mo').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open')}));
function showToast(msg){ const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3100) }
const DAY_KR=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
const COLOR_LBL={yellow:'ë…¸ë‘',blue:'íŒŒë‘',green:'ì´ˆë¡',red:'ë¹¨ê°•',purple:'ë³´ë¼'};

// ë§ë¨¸ë¦¬ ì¶”ê°€ í—¬í¼ í•¨ìˆ˜
function addPrefix(inputId, prefix) {
  const el = $(inputId);
  if (!el.value.startsWith(prefix)) {
    el.value = prefix + ' ' + el.value.replace(/^\[.*?\]\s*/, '');
  }
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentUser = null; 
// ğŸ”¥ [ê³µìœ /ê°œì¸ ì„¤ì •] íŒ€ ì „ì²´ê°€ ë˜‘ê°™ì€ ì¼ì •ì„ ë³¼ì§€, ê°œì¸ë³„ë¡œ ë”°ë¡œ ë³¼ì§€ ê²°ì •í•©ë‹ˆë‹¤.
// false = ê°œì¸ìš© ìº˜ë¦°ë” (ë¡œê·¸ì¸í•œ ì‚¬ëŒ ë°ì´í„°ë§Œ ë³´ì„) / true = íŒ€ ê³µìš© ìº˜ë¦°ë”
const IS_TEAM_SHARED = false; 

let curDate=new Date(), selDate=new Date();
let calView='month'; // 'month' | 'week'
let curProjId=null, curNoteId=null, curTaskId=null, curEvtDate=null;
let curTaskDate=null; 
let curStEditIdx = -1; 
let noteFilter='all';

let localEvents  = [];
let localProjects= [];
let localTasks   = [];
let localNotes   = [];

let fbReady=false, alarmTimer=null;
let dismissed = JSON.parse(localStorage.getItem('fd')||'[]');

let unsubEvents, unsubProjects, unsubTasks, unsubNotes;

// â”€â”€ DB ê²½ë¡œ í—¬í¼ í•¨ìˆ˜ â”€â”€
const getColl = (name) => IS_TEAM_SHARED ? window._fb.collection(window._db, name) : window._fb.collection(window._db, `users/${currentUser.uid}/${name}`);
const getDoc = (name, id) => IS_TEAM_SHARED ? window._fb.doc(window._db, name, id) : window._fb.doc(window._db, `users/${currentUser.uid}/${name}`, id);

function saveLocal() {
  if(!currentUser) return;
  localStorage.setItem('fe_'+currentUser.uid, JSON.stringify(localEvents));
  localStorage.setItem('fp_'+currentUser.uid, JSON.stringify(localProjects));
  localStorage.setItem('ft_'+currentUser.uid, JSON.stringify(localTasks));
  localStorage.setItem('fn_'+currentUser.uid, JSON.stringify(localNotes));
}

function loadLocal() {
  if(!currentUser) return;
  localEvents   = JSON.parse(localStorage.getItem('fe_'+currentUser.uid)||'[]');
  localProjects = JSON.parse(localStorage.getItem('fp_'+currentUser.uid)||'[]');
  localTasks    = JSON.parse(localStorage.getItem('ft_'+currentUser.uid)||'[]');
  localNotes    = JSON.parse(localStorage.getItem('fn_'+currentUser.uid)||'[]');
}

// â”€â”€ Auth ë¡œê·¸ì¸ / íšŒì›ê°€ì… ë¡œì§ â”€â”€
async function handleLogin() {
  const e = $('authEmail').value, p = $('authPwd').value;
  if(!e || !p) return $('authError').textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
  try {
    await window._fbAuth.signInWithEmailAndPassword(window._auth, e, p);
    $('authError').textContent = '';
  } catch(err) {
    $('authError').textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + err.message;
  }
}

async function handleSignUp() {
  const e = $('authEmail').value, p = $('authPwd').value;
  if(!e || !p) return $('authError').textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
  try {
    await window._fbAuth.createUserWithEmailAndPassword(window._auth, e, p);
    $('authError').textContent = '';
    showToast('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
  } catch(err) {
    $('authError').textContent = 'ê°€ì… ì‹¤íŒ¨: ' + err.message;
  }
}

function handleLogout() {
  window._fbAuth.signOut(window._auth);
}

// â”€â”€ Firebase Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('firebaseReady',()=>{
  fbReady=true; $('setupNotice').style.display='none';
  
  // ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€ ë¦¬ìŠ¤ë„ˆ
  window._fbAuth.onAuthStateChanged(window._auth, user => {
    if(user) {
      currentUser = user;
      $('authOverlay').style.display = 'none';
      $('userInfoDisplay').textContent = user.email;
      loadLocal();
      initDataListeners();
    } else {
      currentUser = null;
      $('authOverlay').style.display = 'flex';
      $('userInfoDisplay').textContent = '';
      clearDataListeners();
      
      // ë¡œê·¸ì•„ì›ƒ ì‹œ ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™” ë° í™”ë©´ ë¦¬ë Œë”ë§
      localEvents=[]; localProjects=[]; localTasks=[]; localNotes=[];
      renderCal(); renderWeekView(); renderDayEvts(); renderProjects(); renderTasks(); renderNotesPage();
    }
  });
});
setTimeout(()=>{ if(!fbReady) $('setupNotice').style.display='flex'; },2000);

// ë°ì´í„° êµ¬ë… ì‹œì‘
function initDataListeners() {
  if(!currentUser) return;
  const { onSnapshot, orderBy, query } = window._fb;
  
  unsubEvents = onSnapshot(query(getColl('events'), orderBy('date')), s => {
    localEvents = s.docs.map(d=>({id:d.id, ...d.data()})); saveLocal(); renderCal(); renderWeekView(); renderDayEvts(); updateAlarmPanel();
  });
  unsubProjects = onSnapshot(query(getColl('projects'), orderBy('createdAt')), s => {
    localProjects = s.docs.map(d=>({id:d.id, ...d.data()})); saveLocal(); renderProjects(); updateEvtProjSel();
  });
  unsubTasks = onSnapshot(query(getColl('tasks'), orderBy('createdAt')), s => {
    localTasks = s.docs.map(d=>({id:d.id, ...d.data()})); saveLocal(); renderTasks(); renderCal(); renderWeekView(); renderDayEvts();
  });
  unsubNotes = onSnapshot(query(getColl('notes'), orderBy('createdAt')), s => {
    localNotes = s.docs.map(d=>({id:d.id, ...d.data()})); saveLocal(); renderNotesPage();
  });
}

// ë°ì´í„° êµ¬ë… ì·¨ì†Œ
function clearDataListeners() {
  if(unsubEvents) unsubEvents();
  if(unsubProjects) unsubProjects();
  if(unsubTasks) unsubTasks();
  if(unsubNotes) unsubNotes();
}

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pageMeta={
  calendar:{title:'ìº˜ë¦°ë”',sub:'ì¼ì •ì„ í™•ì¸í•˜ê³  ì¶”ê°€í•˜ì„¸ìš”'},
  projects:{title:'í”„ë¡œì íŠ¸',sub:'í”„ë¡œì íŠ¸ë³„ ì—…ë¬´ì™€ íšŒì˜ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”'},
  tasks:{title:'ì—…ë¬´ ê´€ë¦¬',sub:'ë°˜ë³µ ì—…ë¬´ ë° ìˆ˜ì‹œ ì—…ë¬´ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”'},
  notes:{title:'ë…¸íŠ¸',sub:'ë©”ëª¨ë¥¼ í”„ë¡œì íŠ¸Â·ì—…ë¬´ì— ì—°ê²°í•˜ì—¬ ê´€ë¦¬í•˜ì„¸ìš”'}
};
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  $('page-'+name).classList.add('active');
  document.querySelector(`.nav-item[onclick="showPage('${name}')"]`).classList.add('active');
  $('pageTitle').textContent=pageMeta[name].title;
  $('pageSub').textContent=pageMeta[name].sub;
  if(name==='projects') renderProjects();
  if(name==='tasks') renderTasks();
  if(name==='notes') renderNotesPage();
  if(window.innerWidth<=768) $('sidebar').classList.remove('open');
}
function toggleSidebar(){ $('sidebar').classList.toggle('open') }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ğŸ”” ì•ŒëŒ ì‹œìŠ¤í…œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleAlarmOpt(cb){ cb.closest('.alarm-opt').classList.toggle('sel',cb.checked) }
async function requestNotifPermission(){
  if(!('Notification'in window)){showToast('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');return}
  const p=await Notification.requestPermission();
  if(p==='granted'){
    $('notifBanner').style.display='none'; $('alarmSidebarStatus').textContent='ğŸ”” ì•ŒëŒ í™œì„±í™”ë¨';
    showToast('ì•ŒëŒì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ””'); startAlarmChecker();
  } else showToast('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤');
}
function startAlarmChecker(){ if(alarmTimer)clearInterval(alarmTimer); checkAlarms(); alarmTimer=setInterval(checkAlarms,60000); }
function checkAlarms(){
  const now=new Date(), todayStr=fmtDate(now), nowMin=now.getHours()*60+now.getMinutes();
  
  // ì˜¤ëŠ˜ ì•ŒëŒ í™•ì¸
  const todayEvents = getEventsForDate(todayStr);
  todayEvents.forEach(evt=>{
    if(!evt.alarms)return;
    const t = evt.startTime || evt.time;
    if(!t)return;
    const isDone = (evt.repeatType && evt.repeatType !== 'none') ? (evt.completedDates && evt.completedDates.includes(todayStr)) : evt.done;
    if(isDone) return; 

    const[h,m]=t.split(':').map(Number); const evtMin=h*60+m;
    evt.alarms.forEach(off=>{
      if(off === 1440) return; // ë‚´ì¼ ì¼ì • ì•ŒëŒì€ ë°‘ì—ì„œ ì²˜ë¦¬
      const trig=evtMin-off; const key=(evt.id||evt._lid)+'_'+off+'_'+todayStr;
      if(nowMin>=trig&&nowMin<trig+2&&!dismissed.includes(key)) triggerAlarm(evt,off,key);
    });
  });

  // ë‚´ì¼ ì¼ì • ì•ŒëŒ (1í•˜ë£¨ ì „ ì•ŒëŒ ì²˜ë¦¬)
  const tomorrow = new Date(now); tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = fmtDate(tomorrow);
  const tomorrowEvents = getEventsForDate(tomorrowStr);
  tomorrowEvents.forEach(evt => {
     if (!evt.alarms || !evt.alarms.includes(1440)) return;
     const t = evt.startTime || evt.time;
     if (!t) return;
     const isDone = (evt.repeatType && evt.repeatType !== 'none') ? (evt.completedDates && evt.completedDates.includes(tomorrowStr)) : evt.done;
     if (isDone) return;
     
     const dt = new Date(tomorrowStr + 'T' + t);
     const diff = (dt - now) / 60000;
     if (diff > 1439 && diff <= 1441) {
        const key = (evt.id || evt._lid) + '_1440_' + tomorrowStr;
        if(!dismissed.includes(key)) triggerAlarm(evt, 1440, key);
     }
  });

  updateAlarmPanel();
}
function triggerAlarm(evt,off,key){
  const t = evt.startTime || evt.time;
  const lbl=off===0?'ì§€ê¸ˆ ì‹œì‘!':off===1440?'ë‚´ì¼':`${off}ë¶„ í›„`;
  if('Notification'in window&&Notification.permission==='granted'){
    const n=new Notification(`ğŸ”” ${evt.title}`,{body:`${t} Â· ${lbl}`,tag:key||'flow'});
    n.onclick=()=>{window.focus();n.close()};
  }
  const pop=document.createElement('div');
  pop.className='alarm-popup'+(off===0?' urg':'');
  pop.innerHTML=`<div style="font-size:28px">${off===0?'ğŸš¨':'ğŸ””'}</div><div style="flex:1"><div style="font-size:14px;font-weight:700">${evt.title}</div><div style="font-size:12px;color:var(--muted);margin-top:3px">${t} â€” ${lbl}</div></div><button class="ap-close" onclick="this.parentElement.remove()">í™•ì¸</button>`;
  document.body.appendChild(pop); setTimeout(()=>pop.remove(),off===0?10000:6000);
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)(); const cnt=off===0?3:1;
    for(let i=0;i<cnt;i++){
      const osc=ctx.createOscillator(),g=ctx.createGain(); osc.connect(g); g.connect(ctx.destination);
      osc.frequency.value=off===0?880:660; osc.type='sine';
      g.gain.setValueAtTime(.3,ctx.currentTime+i*.4); g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+i*.4+.35);
      osc.start(ctx.currentTime+i*.4); osc.stop(ctx.currentTime+i*.4+.4);
    }
  }catch(e){}
  if(key){dismissed.push(key);if(dismissed.length>200)dismissed=dismissed.slice(-100);localStorage.setItem('fd',JSON.stringify(dismissed))}
}
function toggleAlarmPanel(){ $('alarmPanel').classList.toggle('open') }
document.addEventListener('click',e=>{ const p=$('alarmPanel'),b=document.querySelector('.bell-btn'); if(!p.contains(e.target)&&!b.contains(e.target))p.classList.remove('open'); });
function updateAlarmPanel(){
  const now=new Date(); const upcoming=[];
  const d1 = new Date(), d2 = new Date(now); d2.setDate(d2.getDate()+1);
  const dates = [fmtDate(d1), fmtDate(d2)];
  
  dates.forEach(ds => {
    const evts = getEventsForDate(ds);
    evts.forEach(evt => {
      if(!evt.alarms) return;
      const t = evt.startTime || evt.time;
      if(!t) return;
      
      const isDone = (evt.repeatType && evt.repeatType !== 'none') ? (evt.completedDates && evt.completedDates.includes(ds)) : evt.done;
      if (isDone) return;
      
      const dt = new Date(ds + 'T' + t);
      if (dt < now) return;
      
      evt.alarms.forEach(off => {
        const at = new Date(dt - off*60000);
        if (at > now) upcoming.push({evt, at, off, ds});
      });
    });
  });

  upcoming.sort((a,b)=>a.at-b.at);
  const badge=$('alarmBadge'); badge.textContent=upcoming.length; badge.style.display=upcoming.length>0?'flex':'none';
  const body=$('alarmPanelBody');
  if(!upcoming.length){body.innerHTML='<div class="empty" style="padding:24px"><div class="ei">ğŸ”•</div><p>ì˜ˆì •ëœ ì•ŒëŒ ì—†ìŒ</p></div>';return}
  body.innerHTML=upcoming.slice(0,20).map(({evt,at,off,ds})=>{
    const t = evt.startTime || evt.time;
    const dm=Math.round((at-now)/60000); const urg=dm<=10,soon=dm<=60;
    const dl=dm<60?`${dm}ë¶„ í›„`:dm<1440?`${Math.round(dm/60)}ì‹œê°„ í›„`:`${Math.round(dm/1440)}ì¼ í›„`;
    const ol=off===0?'ì •ì‹œ':off===1440?'í•˜ë£¨ ì „':`${off}ë¶„ ì „`;
    return`<div class="ai"><div class="ai-dot${urg?' urgent':soon?' soon':''}"></div><div style="flex:1"><div style="font-size:13px;font-weight:500">${evt.title}</div><div style="font-size:11px;color:var(--muted);margin-top:2px">${ds} ${t} Â· ${ol} Â· <strong>${dl}</strong></div></div><button class="ai-dismiss" onclick="dismissAlarm('${evt.id||evt._lid}',${off},'${ds}',this)">âœ•</button></div>`;
  }).join('');
}
function dismissAlarm(eid,off,ds,btn){
  const k=eid+'_'+off+'_'+ds; if(!dismissed.includes(k))dismissed.push(k);
  localStorage.setItem('fd',JSON.stringify(dismissed)); btn.closest('.ai').remove(); updateAlarmPanel();
}
function dismissAllAlarms(){
  localEvents.forEach(evt=>{if(!evt.alarms)return;const t=fmtDate(new Date());evt.alarms.forEach(o=>dismissed.push((evt.id||evt._lid)+'_'+o+'_'+t));});
  localStorage.setItem('fd',JSON.stringify(dismissed)); updateAlarmPanel(); $('alarmPanel').classList.remove('open'); showToast('ëª¨ë“  ì•ŒëŒì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ğŸ“… ìº˜ë¦°ë” + D-day + ë°˜ë³µ ì—…ë¬´ í‘œì‹œ + ì£¼ê°„ ë³´ê¸°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getDday(dateStr){
  const today=new Date(fmtDate(new Date())+'T00:00:00');
  const target=new Date(dateStr+'T00:00:00');
  const diff=Math.round((target-today)/(1000*60*60*24));
  if(diff===0) return{label:'D-Day',cls:'dday-today'};
  if(diff>0&&diff<=7) return{label:`D-${diff}`,cls:'dday-soon'};
  if(diff>7) return{label:`D-${diff}`,cls:'dday-future'};
  return{label:`D+${Math.abs(diff)}`,cls:'dday-past'};
}

// íŠ¹ì • ë‚ ì§œì— í•´ë‹¹í•˜ëŠ” ë°˜ë³µ ì¼ì •/ì—…ë¬´ ê°€ì ¸ì˜¤ê¸°
function getEventsForDate(ds) {
  const d = new Date(ds + 'T00:00:00');
  const dow = d.getDay();
  const dom = d.getDate();
  return localEvents.filter(e => {
    if (!e.repeatType || e.repeatType === 'none') return e.date === ds;
    const startDate = new Date(e.date + 'T00:00:00');
    if (d < startDate) return false;
    if (e.repeatType === 'daily') return true;
    if (e.repeatType === 'weekly') return e.repeatDays && e.repeatDays.includes(dow);
    if (e.repeatType === 'monthly') return e.repeatDates && e.repeatDates.includes(dom);
    return false;
  });
}

function getRecurringTasksForDate(ds){
  const d=new Date(ds+'T00:00:00'), dow=d.getDay(), dom=d.getDate();
  return localTasks.filter(t=>{
    if(t.type==='recurring-daily') return true;
    if(t.type==='recurring-weekly') return t.repeatDays&&t.repeatDays.includes(dow);
    if(t.type==='recurring-monthly') return t.repeatDates&&t.repeatDates.includes(dom);
    return false;
  });
}

function setView(v){
  calView=v;
  $('vt-month').classList.toggle('active',v==='month');
  $('vt-week').classList.toggle('active',v==='week');
  $('monthView').style.display=v==='month'?'block':'none';
  $('weekView').style.display=v==='week'?'block':'none';
  updateCalTitle();
  if(v==='week') renderWeekView();
}
function changeView(dir){
  if(calView==='month') curDate.setMonth(curDate.getMonth()+dir);
  else curDate.setDate(curDate.getDate()+dir*7);
  updateCalTitle();
  if(calView==='month') renderCal();
  else renderWeekView();
}
function goToday(){ curDate=new Date(); selDate=new Date(); updateCalTitle(); if(calView==='month'){renderCal();renderDayEvts();}else renderWeekView(); }
function updateCalTitle(){
  const y=curDate.getFullYear(),m=curDate.getMonth();
  if(calView==='month'){ $('calTitle').textContent=`${y}ë…„ ${m+1}ì›”`; return; }
  const dow=curDate.getDay();
  const mon=new Date(curDate); mon.setDate(curDate.getDate()-dow);
  const sun=new Date(mon); sun.setDate(mon.getDate()+6);
  $('calTitle').textContent=`${mon.getMonth()+1}ì›” ${mon.getDate()}ì¼ â€” ${sun.getMonth()+1}ì›” ${sun.getDate()}ì¼`;
}

// â”€â”€ ì›”ê°„ ë·° â”€â”€
function renderCal(){
  const g=$('calGrid'),y=curDate.getFullYear(),m=curDate.getMonth();
  const wds=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  let html=wds.map(w=>`<div class="cal-wd">${w}</div>`).join('');
  const fd=new Date(y,m,1).getDay(),dm=new Date(y,m+1,0).getDate(),pd=new Date(y,m,0).getDate();
  const todayStr=fmtDate(new Date()), total=Math.ceil((fd+dm)/7)*7;
  for(let i=0;i<total;i++){
    let day,other=false,d;
    if(i<fd){day=pd-fd+i+1;d=new Date(y,m-1,day);other=true}
    else if(i>=fd+dm){day=i-fd-dm+1;d=new Date(y,m+1,day);other=true}
    else{day=i-fd+1;d=new Date(y,m,day)}
    const ds=fmtDate(d), isToday=ds===todayStr, isSel=ds===fmtDate(selDate);
    
    const devts=getEventsForDate(ds);
    const rtasks=getRecurringTasksForDate(ds);
    
    const allItems=[
      ...devts.map(e=>{
        const dd=e.type==='deadline'?getDday(e.date):null;
        const ddLabel=dd?`<span class="dday ${dd.cls}" style="font-size:9px;padding:0 3px;border-radius:6px">${dd.label}</span>`:'';
        const isDone = (e.repeatType && e.repeatType !== 'none') ? (e.completedDates && e.completedDates.includes(ds)) : e.done;
        const repIcon = (e.repeatType && e.repeatType !== 'none') ? 'ğŸ” ' : '';
        return`<div class="cev ${e.type}${e.alarms&&e.alarms.length?' has-alarm':''}${isDone?' done':''}" onclick="event.stopPropagation();openEventDetail('${e.id||e._lid}', '${ds}')">${repIcon}${e.title}${ddLabel}</div>`;
      }),
      ...rtasks.map(t=>{
        const isDone = t.completedDates && t.completedDates.includes(ds);
        return `<div class="cev recurring${isDone?' done':''}" onclick="event.stopPropagation();openTaskDetail('${t.id||t._lid}', '${ds}')">${t.time?'â°':''} ${t.title}</div>`;
      })
    ];
    const visible=allItems.slice(0,3);
    const more=allItems.length>3?`<div class="cev more">+${allItems.length-3}</div>`:'';
    html+=`<div class="cal-day${other?' other':''}${isToday?' today':''}${isSel?' sel':''}" onclick="selectDate('${ds}')">
      <div class="cal-dn">${day}</div><div class="cal-dots">${visible.join('')}${more}</div></div>`;
  }
  g.innerHTML=html;
}

// â”€â”€ ì£¼ê°„ ë·° â”€â”€
function renderWeekView(){
  const dow=curDate.getDay();
  const weekStart=new Date(curDate); weekStart.setDate(curDate.getDate()-dow);
  const days=Array.from({length:7},(_,i)=>{ const d=new Date(weekStart); d.setDate(weekStart.getDate()+i); return d; });
  const todayStr=fmtDate(new Date()), selStr=fmtDate(selDate);
  const typeColors={meeting:'var(--accent-l)',task:'var(--green-l)',deadline:'var(--red-l)',reminder:'var(--warn-l)',recurring:'#F5F3FF'};
  const typeTxt={meeting:'var(--accent)',task:'var(--green)',deadline:'var(--red)',reminder:'var(--warn)',recurring:'var(--purple)'};

  let html=`<div class="wv-head"><div class="wv-corner"></div>`;
  days.forEach(d=>{
    const ds=fmtDate(d),isToday=ds===todayStr,isSel=ds===selStr;
    html+=`<div class="wv-dh${isToday?' today':''}${isSel?' sel-day':''}" onclick="selectDate('${ds}')">
      <span class="wv-dn">${d.getDate()}</span><span class="wv-dw">${DAY_KR[d.getDay()]}</span></div>`;
  });
  html+=`</div>`;

  html+=`<div class="wv-allday"><div class="wv-al-lbl">ì¢…ì¼</div>`;
  days.forEach(d=>{
    const ds=fmtDate(d);
    const devts = getEventsForDate(ds);
    const noTimeEvts=devts.filter(e=>!e.startTime && !e.time);
    const rtasks=getRecurringTasksForDate(ds).filter(t=>!t.time);
    html+=`<div class="wv-al-cell">`;
    noTimeEvts.forEach(e=>{
      const dd=e.type==='deadline'?getDday(ds):null;
      const ddTxt=dd?` ${dd.label}`:'';
      const isDone = (e.repeatType && e.repeatType !== 'none') ? (e.completedDates && e.completedDates.includes(ds)) : e.done;
      const repIcon = (e.repeatType && e.repeatType !== 'none') ? 'ğŸ” ' : '';
      html+=`<div class="cev ${e.type}${isDone?' done':''}" style="font-size:10px" onclick="openEventDetail('${e.id||e._lid}', '${ds}')">${repIcon}${e.title}${ddTxt}</div>`;
    });
    rtasks.forEach(t=>{
      const isDone = t.completedDates && t.completedDates.includes(ds);
      html+=`<div class="cev recurring${isDone?' done':''}" onclick="openTaskDetail('${t.id||t._lid}', '${ds}')">${t.title}</div>`;
    });
    html+=`</div>`;
  });
  html+=`</div>`;

  html+=`<div class="wv-body">`;
  for(let h=0;h<24;h++){
    const label=h===0?'':h<12?`ì˜¤ì „ ${h}ì‹œ`:h===12?`ë‚® 12ì‹œ`:`ì˜¤í›„ ${h-12}ì‹œ`;
    html+=`<div class="wv-time">${label}</div>`;
    days.forEach(d=>{
      const ds=fmtDate(d);
      const devts = getEventsForDate(ds);
      const hEvts=devts.filter(e=>{
        const t = e.startTime || e.time;
        if(!t)return false;
        return parseInt(t.split(':')[0])===h;
      });
      const tEvts=localTasks.filter(t=>{
        if(!t.time)return false;
        const tDow=d.getDay(),tDom=d.getDate();
        let matches=false;
        if(t.type==='recurring-daily')matches=true;
        else if(t.type==='recurring-weekly')matches=t.repeatDays&&t.repeatDays.includes(tDow);
        else if(t.type==='recurring-monthly')matches=t.repeatDates&&t.repeatDates.includes(tDom);
        return matches&&parseInt(t.time.split(':')[0])===h;
      });
      html+=`<div class="wv-cell">`;
      hEvts.forEach(e=>{
        const t = e.startTime || e.time;
        const min=parseInt(t.split(':')[1]);
        const topPct=min/60*100;
        const isDone = (e.repeatType && e.repeatType !== 'none') ? (e.completedDates && e.completedDates.includes(ds)) : e.done;
        const repIcon = (e.repeatType && e.repeatType !== 'none') ? 'ğŸ” ' : '';
        let timeTxt = t.slice(3) ? t : '';
        if(e.endTime) timeTxt += `~${e.endTime}`;
        html+=`<div class="wv-evt${isDone?' done':''}" style="top:${topPct}%;background:${typeColors[e.type]||typeColors.meeting};color:${typeTxt[e.type]||typeTxt.meeting};border-left:2px solid ${typeTxt[e.type]||typeTxt.meeting}" onclick="openEventDetail('${e.id||e._lid}', '${ds}')">${timeTxt} ${repIcon}${e.title}</div>`;
      });
      tEvts.forEach(t=>{
        const min=parseInt(t.time.split(':')[1]);
        const isDone = t.completedDates && t.completedDates.includes(ds);
        html+=`<div class="wv-evt${isDone?' done':''}" style="top:${min/60*100}%;background:#F5F3FF;color:var(--purple);border-left:2px solid var(--purple)" onclick="openTaskDetail('${t.id||t._lid}', '${ds}')">ğŸ” ${t.title}</div>`;
      });
      html+=`</div>`;
    });
  }
  html+=`</div>`;
  $('weekGrid').innerHTML=html;
}

// â”€â”€ ë‚ ì§œ ì„ íƒ & ì‚¬ì´ë“œ íŒ¨ë„ â”€â”€
function selectDate(ds){
  selDate=new Date(ds+'T00:00:00');
  if(calView==='month') renderCal();
  else renderWeekView();
  renderDayEvts();
  $('selDateTitle').textContent=`${selDate.getMonth()+1}ì›” ${selDate.getDate()}ì¼ ì¼ì •`;
}

function renderDayEvts(){
  const ds=fmtDate(selDate), el=$('dayEvtList');
  const evts=getEventsForDate(ds);
  const rtasks=getRecurringTasksForDate(ds);
  const tl={meeting:'ğŸ“‹ íšŒì˜',task:'âœ… ì—…ë¬´',deadline:'ğŸ”´ ë§ˆê°',reminder:'ğŸ”” ì•Œë¦¼'};

  let html='';
  evts.forEach(e=>{
    const eid=e.id||e._lid;
    const dd=e.type==='deadline'?getDday(e.date):null;
    const ddBadge=dd?`<span class="dday ${dd.cls}">${dd.label}</span>`:'';
    const isDone = (e.repeatType && e.repeatType !== 'none') ? (e.completedDates && e.completedDates.includes(ds)) : e.done;
    const repIcon = (e.repeatType && e.repeatType !== 'none') ? 'ğŸ” ' : '';
    
    let timeStr = e.startTime || e.time || '';
    if (timeStr && e.endTime) timeStr += ' ~ ' + e.endTime;
    
    html+=`<div class="evt-item ${e.type}" style="display:flex; align-items:flex-start; gap:10px; cursor:pointer;" onclick="openEventDetail('${eid}', '${ds}')">
      <div class="t-check${isDone?' done':''}" style="margin-top:2px;" onclick="event.stopPropagation(); toggleEventDone('${eid}', '${ds}')"></div>
      <div style="flex:1">
        <div style="font-size:13px;font-weight:500;display:flex;align-items:center;gap:6px;flex-wrap:wrap;${isDone?'text-decoration:line-through;color:var(--muted)':''}">${repIcon}${e.title}${ddBadge}${e.alarms&&e.alarms.length?'<span title="ì•ŒëŒ ì„¤ì •ë¨" style="font-size:11px">ğŸ””</span>':''}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">${timeStr?'â° '+timeStr+' Â· ':''}${tl[e.type]||e.type}${e.projectId?' Â· ğŸ“ '+getProjName(e.projectId):''}${e.alarms&&e.alarms.length?' Â· ì•ŒëŒ':''}</div>
        ${e.note?`<div style="font-size:12px;color:var(--muted);margin-top:4px">${e.note}</div>`:''}
      </div>
    </div>`;
  });
  rtasks.forEach(t=>{
    const tid=t.id||t._lid;
    const isDone = t.completedDates && t.completedDates.includes(ds);
    html+=`<div class="evt-item recurring-task" style="display:flex; align-items:flex-start; gap:10px; cursor:pointer;" onclick="openTaskDetail('${tid}', '${ds}')">
      <div class="t-check${isDone?' done':''}" style="margin-top:2px;" onclick="event.stopPropagation(); toggleTaskDone('${tid}', '${ds}')"></div>
      <div style="flex:1">
        <div style="font-size:13px;font-weight:500;color:var(--purple);${isDone?'text-decoration:line-through;opacity:0.5;':''}">ğŸ” ${t.title}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">${t.time?'â° '+t.time+' Â· ':''}ë°˜ë³µ ì—…ë¬´${t.assignee?' Â· ğŸ‘¤ '+t.assignee:''}</div>
      </div>
    </div>`;
  });

  el.innerHTML = html || '<div class="empty"><div class="ei">ğŸ“…</div><p>ì´ ë‚ ì˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
}

// â”€â”€ ì¼ì • ë°˜ë³µ UI í•¸ë“¤ë§ â”€â”€
function onEvtRepeatChange(val) {
  $('evtWeeklyPicker').classList.remove('show');
  $('evtMonthlyPicker').classList.remove('show');
  if (val === 'weekly') $('evtWeeklyPicker').classList.add('show');
  if (val === 'monthly') {
    $('evtMonthlyPicker').classList.add('show');
    buildEvtDateBtns();
  }
}
function buildEvtDateBtns() {
  const c = $('evtMonthlyDates'); if (c.children.length) return;
  c.innerHTML = Array.from({length: 31}, (_, i) => `<button type="button" class="evt-date-btn date-btn" data-d="${i+1}" onclick="this.classList.toggle('sel')">${i+1}</button>`).join('');
}
function getSelEvtDays() { return [...document.querySelectorAll('.evt-day-btn.sel')].map(b => parseInt(b.dataset.d)); }
function getSelEvtDates() { return [...document.querySelectorAll('.evt-date-btn.sel')].map(b => parseInt(b.dataset.d)); }

// â”€â”€ ì¼ì • ì™„ë£Œ/ìƒì„¸/ìˆ˜ì •/ì‚­ì œ â”€â”€
async function toggleEventDone(eid, dateStr) {
  const e = localEvents.find(x => (x.id || x._lid) === eid);
  if (!e) return;
  
  if (e.repeatType && e.repeatType !== 'none') {
    if (!e.completedDates) e.completedDates = [];
    const idx = e.completedDates.indexOf(dateStr);
    if (idx > -1) e.completedDates.splice(idx, 1);
    else e.completedDates.push(dateStr);
    
    if (fbReady) await window._fb.updateDoc(getDoc('events', eid), { completedDates: e.completedDates });
  } else {
    e.done = !e.done;
    if (fbReady) await window._fb.updateDoc(getDoc('events', eid), { done: e.done });
  }
  
  if (!fbReady) saveLocal(); 
  renderCal(); renderWeekView(); renderDayEvts();
}

function openEventDetail(eid, ds){
  curEvtDate = ds || fmtDate(selDate);
  const e=localEvents.find(x=>(x.id||x._lid)===eid); if(!e)return;
  
  $('evtModalTitle').textContent='ì¼ì • ìˆ˜ì •';
  let timeStr = e.startTime || e.time || '';
  if(timeStr && e.endTime) timeStr += ' ~ ' + e.endTime;
  $('evtDateLabel').textContent=`${e.date} ${timeStr}`;
  
  $('evtTitle').value=e.title||'';
  $('evtDate').value=e.date||'';
  $('evtStartTime').value=e.startTime || e.time || '';
  $('evtEndTime').value=e.endTime || '';
  $('evtType').value=e.type||'meeting';
  $('evtNote').value=e.note||'';
  $('evtEditId').value=eid;
  $('evtDelBtn').style.display='inline-flex';
  
  $('evtRepeatType').value = e.repeatType || 'none';
  onEvtRepeatChange(e.repeatType || 'none');
  
  document.querySelectorAll('.evt-day-btn, .evt-date-btn').forEach(b => b.classList.remove('sel'));
  if (e.repeatDays) document.querySelectorAll('.evt-day-btn').forEach(b => { if (e.repeatDays.includes(parseInt(b.dataset.d))) b.classList.add('sel'); });
  if (e.repeatDates) document.querySelectorAll('.evt-date-btn').forEach(b => { if (e.repeatDates.includes(parseInt(b.dataset.d))) b.classList.add('sel'); });

  const isDone = (e.repeatType && e.repeatType !== 'none') ? (e.completedDates && e.completedDates.includes(curEvtDate)) : e.done;
  if(isDone) $('evtDoneCheck').classList.add('done');
  else $('evtDoneCheck').classList.remove('done');
  $('evtDoneDateHint').textContent = (e.repeatType && e.repeatType !== 'none') ? `(ê¸°ì¤€ì¼: ${curEvtDate})` : '';

  updateEvtProjSel();
  $('evtProject').value=e.projectId||'';
  document.querySelectorAll('.alarm-opt input').forEach(cb=>{
    cb.checked=e.alarms&&e.alarms.includes(parseInt(cb.value));
    cb.closest('.alarm-opt').classList.toggle('sel',cb.checked);
  });
  openModal('moAddEvent');
}

function openAddEvent(){
  $('evtModalTitle').textContent='ì¼ì • ì¶”ê°€';
  $('evtTitle').value=''; $('evtDate').value=fmtDate(selDate); 
  $('evtStartTime').value=''; $('evtEndTime').value='';
  $('evtNote').value=''; $('evtType').value='meeting';
  $('evtDateLabel').textContent=`${selDate.getFullYear()}ë…„ ${selDate.getMonth()+1}ì›” ${selDate.getDate()}ì¼`;
  $('evtEditId').value=''; $('evtDelBtn').style.display='none';
  $('evtDoneCheck').classList.remove('done');
  $('evtDoneDateHint').textContent = '';
  
  $('evtRepeatType').value = 'none';
  onEvtRepeatChange('none');
  document.querySelectorAll('.evt-day-btn, .evt-date-btn').forEach(b => b.classList.remove('sel'));
  
  document.querySelectorAll('.alarm-opt input').forEach(cb=>{cb.checked=false;cb.closest('.alarm-opt').classList.remove('sel')});
  updateEvtProjSel(); openModal('moAddEvent');
}

async function saveEvent(){
  const title=$('evtTitle').value.trim(); if(!title){showToast('ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”');return}
  const alarms=[...$('moAddEvent').querySelectorAll('.alarm-opt input:checked')].map(c=>parseInt(c.value));
  const isDone = $('evtDoneCheck').classList.contains('done');
  const repeatType = $('evtRepeatType').value;
  const editId=$('evtEditId').value;
  
  let completedDates = [];
  if (editId) {
    const existing = localEvents.find(x => (x.id||x._lid) === editId);
    if (existing && existing.completedDates) completedDates = existing.completedDates;
  }
  if (repeatType !== 'none' && curEvtDate) {
    const idx = completedDates.indexOf(curEvtDate);
    if (isDone && idx === -1) completedDates.push(curEvtDate);
    else if (!isDone && idx > -1) completedDates.splice(idx, 1);
  }

  const evt={
    title, 
    date:$('evtDate').value,
    startTime:$('evtStartTime').value,
    endTime:$('evtEndTime').value,
    type:$('evtType').value,
    projectId:$('evtProject').value,
    note:$('evtNote').value,
    alarms, 
    repeatType,
    repeatDays: repeatType === 'weekly' ? getSelEvtDays() : [],
    repeatDates: repeatType === 'monthly' ? getSelEvtDates() : [],
    done: repeatType === 'none' ? isDone : false,
    completedDates: repeatType !== 'none' ? completedDates : [],
    author: currentUser ? currentUser.email : ''
  };
  
  if(editId){
    if(fbReady){await window._fb.updateDoc(getDoc('events', editId),evt)}
    else{const idx=localEvents.findIndex(e=>(e.id||e._lid)===editId);if(idx>=0)localEvents[idx]={...localEvents[idx],...evt};saveLocal();renderCal();renderWeekView();renderDayEvts()}
    showToast('ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“');
  } else {
    if(fbReady){await window._fb.addDoc(getColl('events'),{...evt,createdAt:window._fb.serverTimestamp()})}
    else{evt._lid='e_'+Date.now();localEvents.push(evt);saveLocal();renderCal();renderWeekView();renderDayEvts()}
    if(alarms.length&&Notification.permission==='default')requestNotifPermission();
    showToast('ì¼ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“');
  }
  updateAlarmPanel(); closeModal('moAddEvent');
}

async function deleteEventFromModal(){
  const eid=$('evtEditId').value; if(!eid)return;
  if(!confirm('ì´ ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?'))return;
  if(fbReady){await window._fb.deleteDoc(getDoc('events', eid))}
  else{localEvents=localEvents.filter(e=>(e.id||e._lid)!==eid);saveLocal();renderCal();renderWeekView();renderDayEvts()}
  closeModal('moAddEvent'); showToast('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

function updateEvtProjSel(){
  $('evtProject').innerHTML='<option value="">ì—†ìŒ</option>'+localProjects.map(p=>`<option value="${p.id||p._lid}">${p.name}</option>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ğŸ“ í”„ë¡œì íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const statusTag={active:'<span class="tag tag-b">ì§„í–‰ì¤‘</span>',planning:'<span class="tag tag-a">ê³„íšì¤‘</span>',completed:'<span class="tag tag-g">ì™„ë£Œ</span>',hold:'<span class="tag">ë³´ë¥˜</span>'};

function renderProjects(){
  const g=$('projGrid');
  if(!localProjects.length){g.innerHTML='<div class="empty" style="grid-column:1/-1"><div class="ei">ğŸ“</div><p>í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';return}
  g.innerHTML=localProjects.map(p=>{
    const pid=p.id||p._lid;
    let projDday='';
    if(p.endDate){ const dd=getDday(p.endDate); projDday=`<span class="dday ${dd.cls}" style="margin-left:6px">${dd.label}</span>`; }
    return`<div class="proj-card" onclick="openProjDetail('${pid}')">
      <div class="pc-body">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div style="display:flex;align-items:center">${statusTag[p.status]||''}</div>
          <button class="btn btn-ic btn-sm" style="font-size:12px" onclick="event.stopPropagation();openEditProjectById('${pid}')">âœï¸</button>
        </div>
        <div class="pc-title" style="margin-top:8px">${p.name}</div>
        <div class="pc-desc">${p.desc||''}</div>
        <div class="pc-bar"><div class="pc-fill" style="width:0%"></div></div>
        <div class="pc-stats"><span>ğŸ“‹ ì„¸ë¶€ì—…ë¬´ ${getStCount(pid)}ê°œ</span><span>ğŸ“ íšŒì˜ ${getMtCount(pid)}ê°œ</span><span>ğŸ”— ë…¸íŠ¸ ${getLinkedNoteCount('project',pid)}ê°œ</span></div>
      </div>
      <div class="pc-foot"><span>${p.startDate?p.startDate+' ~ ':''} ${p.endDate||''}${projDday}</span><span>â€º</span></div>
    </div>`;
  }).join('');
}
function getProjName(pid){const p=localProjects.find(x=>(x.id||x._lid)===pid);return p?p.name:''}
function getStCount(pid){return(JSON.parse(localStorage.getItem('st_'+pid)||'[]')).length}
function getMtCount(pid){return(JSON.parse(localStorage.getItem('mt_'+pid)||'[]')).length}
function getLinkedNoteCount(type,tid){return localNotes.filter(n=>n.linkType===type&&n.linkTargetId===tid).length}

function openAddProject(){
  $('projModalTitle').textContent='ìƒˆ í”„ë¡œì íŠ¸';
  ['projName','projDesc','projEnd'].forEach(id=>$(id).value='');
  $('projStart').value=fmtDate(new Date()); $('projStatus').value='active'; $('projEditId').value='';
  $('projDelBtn').style.display='none';
  openModal('moAddProject');
}
function openEditProject(){ openEditProjectById(curProjId); }
function openEditProjectById(pid){
  const p=localProjects.find(x=>(x.id||x._lid)===pid); if(!p)return;
  $('projModalTitle').textContent='í”„ë¡œì íŠ¸ ìˆ˜ì •';
  $('projName').value=p.name||''; $('projDesc').value=p.desc||'';
  $('projStart').value=p.startDate||''; $('projEnd').value=p.endDate||'';
  $('projStatus').value=p.status||'active'; $('projEditId').value=pid;
  $('projDelBtn').style.display='inline-flex';
  closeModal('moProjDetail'); openModal('moAddProject');
}
async function saveProject(){
  const name=$('projName').value.trim(); if(!name){showToast('í”„ë¡œì íŠ¸ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”');return}
  const proj={name,desc:$('projDesc').value,startDate:$('projStart').value,endDate:$('projEnd').value,status:$('projStatus').value, author: currentUser ? currentUser.email : ''};
  const editId=$('projEditId').value;
  if(editId){
    if(fbReady){await window._fb.updateDoc(getDoc('projects', editId),proj)}
    else{const idx=localProjects.findIndex(p=>(p.id||p._lid)===editId);if(idx>=0)localProjects[idx]={...localProjects[idx],...proj};saveLocal();renderProjects();updateEvtProjSel()}
    showToast('í”„ë¡œì íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“');
  } else {
    if(fbReady){await window._fb.addDoc(getColl('projects'),{...proj,createdAt:window._fb.serverTimestamp()})}
    else{proj._lid='p_'+Date.now();localProjects.push(proj);saveLocal();renderProjects();updateEvtProjSel()}
    showToast('í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“');
  }
  closeModal('moAddProject');
}

async function deleteProject(){
  const pid=$('projEditId').value; if(!pid)return;
  if(!confirm('ì´ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí• ê¹Œìš”? (ì—°ê²°ëœ ëª¨ë“  ì„¸ë¶€ ë°ì´í„°ê°€ í•¨ê»˜ ê´€ë¦¬ ëŒ€ìƒì—ì„œ ì œì™¸ë©ë‹ˆë‹¤)'))return;
  
  if(fbReady){
    await window._fb.deleteDoc(getDoc('projects', pid));
  } else {
    localProjects=localProjects.filter(p=>(p.id||p._lid)!==pid);
    saveLocal(); renderProjects(); updateEvtProjSel();
  }
  closeModal('moAddProject'); showToast('í”„ë¡œì íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  if(curProjId===pid) closeModal('moProjDetail');
}

function openProjDetail(pid){
  curProjId=pid;
  const p=localProjects.find(x=>(x.id||x._lid)===pid); if(!p)return;
  $('dpTitle').textContent=p.name; $('dpStatus').innerHTML=statusTag[p.status]||'';
  let datesTxt=[p.startDate,p.endDate].filter(Boolean).join(' ~ ');
  if(p.endDate){ const dd=getDday(p.endDate); datesTxt+=` (${dd.label})`; }
  $('dpDates').textContent=datesTxt;
  switchProjTab('subtasks'); renderSubtasks(); renderMeetings(); renderProjNotes(); renderLinkedNotes();
  openModal('moProjDetail');
}
function switchProjTab(tab){
  const tabs=['subtasks','meetings','notes','linkednotes'];
  tabs.forEach(t=>{ const el=$('pt-'+t);if(el)el.classList.toggle('active',t===tab); });
  document.querySelectorAll('#moProjDetail .m-tab').forEach((el,i)=>el.classList.toggle('active',tabs[i]===tab));
}

// â”€â”€ Subtasks â”€â”€
function getSubtasks(pid){return JSON.parse(localStorage.getItem('st_'+pid)||'[]')}
function setSubtasks(pid,d){localStorage.setItem('st_'+pid,JSON.stringify(d))}
function renderSubtasks(){
  const tasks=getSubtasks(curProjId),done=tasks.filter(t=>t.done).length;
  $('stStats').textContent=`ì „ì²´ ${tasks.length}ê°œ Â· ì™„ë£Œ ${done}ê°œ Â· ì§„í–‰ì¤‘ ${tasks.length-done}ê°œ`;
  const pc={high:'var(--red)',medium:'var(--warn)',low:'var(--green)'};
  const pl={high:'ë†’ìŒ',medium:'ë³´í†µ',low:'ë‚®ìŒ'};
  $('subtaskList').innerHTML=!tasks.length?'<div class="empty"><div class="ei">ğŸ“‹</div><p>ì„¸ë¶€ ì—…ë¬´ë¥¼ ì¶”ê°€í•´ ë³´ì„¸ìš”</p></div>':
    tasks.map((t,i)=>`<div class="task-item"><div class="t-check${t.done?' done':''}" onclick="toggleSt(${i})"></div>
      <div class="t-body"><div class="t-title${t.done?' done':''}">${t.title}</div>
      <div class="t-meta">${t.assignee?'ğŸ‘¤ '+t.assignee:''}${t.due?' ğŸ“… '+t.due:''}<span style="color:${pc[t.priority]}">â— ${pl[t.priority]}</span></div></div>
      <div style="display:flex;gap:4px">
        <button class="btn btn-ic btn-sm" onclick="editSt(${i})">âœï¸</button>
        <button class="btn btn-ic btn-sm" style="color:var(--red)" onclick="deleteSt(${i})">ğŸ—‘</button>
      </div></div>`).join('');
}
function openAddSubtask(){
  ['stTitle','stAssignee','stDue'].forEach(id=>$(id).value='');
  $('stStart').value=fmtDate(new Date());$('stPriority').value='medium';
  curStEditIdx = -1;
  $('addStForm').style.display='block';
}
function editSt(i){
  const t = getSubtasks(curProjId)[i];
  $('stTitle').value=t.title||''; $('stAssignee').value=t.assignee||'';
  $('stStart').value=t.start||''; $('stDue').value=t.due||'';
  $('stPriority').value=t.priority||'medium';
  curStEditIdx = i;
  $('addStForm').style.display='block';
}
function saveSubtask(){
  const t=$('stTitle').value.trim();if(!t){showToast('ì—…ë¬´ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”');return}
  const tasks=getSubtasks(curProjId);
  const data = {title:t,assignee:$('stAssignee').value,start:$('stStart').value,due:$('stDue').value,priority:$('stPriority').value,done:curStEditIdx>=0?tasks[curStEditIdx].done:false};
  if(curStEditIdx >= 0) tasks[curStEditIdx] = data; else tasks.push(data);
  setSubtasks(curProjId,tasks);$('addStForm').style.display='none';renderSubtasks();
  showToast(curStEditIdx>=0?'ì„¸ë¶€ ì—…ë¬´ ìˆ˜ì • âœ“':'ì„¸ë¶€ ì—…ë¬´ ì¶”ê°€ âœ“');
}
function toggleSt(i){const t=getSubtasks(curProjId);t[i].done=!t[i].done;setSubtasks(curProjId,t);renderSubtasks()}
function deleteSt(i){const t=getSubtasks(curProjId);t.splice(i,1);setSubtasks(curProjId,t);renderSubtasks()}

// â”€â”€ Meetings â”€â”€
function getMeetings(pid){return JSON.parse(localStorage.getItem('mt_'+pid)||'[]')}
function setMeetings(pid,d){localStorage.setItem('mt_'+pid,JSON.stringify(d))}
function renderMeetings(){
  const m=getMeetings(curProjId);
  $('meetingList').innerHTML=!m.length?'<div class="empty"><div class="ei">ğŸ¤</div><p>íšŒì˜ ê¸°ë¡ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”</p></div>':
    m.map((mt,i)=>`<div class="meeting-item"><div style="display:flex;justify-content:space-between">
      <div><div style="font-size:13px;font-weight:600">ğŸ“‹ ${mt.title}</div><div style="font-size:12px;color:var(--muted);margin-top:4px">ğŸ“… ${mt.date} ${mt.time||''}${mt.attendees?' Â· ğŸ‘¥ '+mt.attendees:''}</div></div>
      <button class="btn btn-ic btn-sm" style="color:var(--red)" onclick="deleteMt(${i})">ğŸ—‘</button></div>
      ${mt.notes?`<div style="font-size:13px;margin-top:8px;line-height:1.6;border-top:1px solid var(--border);padding-top:8px">${mt.notes.replace(/\n/g,'<br>')}</div>`:''}</div>`).join('');
}
function openAddMeeting(){
  ['mtTitle','mtAttendees','mtNotes','mtTime'].forEach(id=>$(id).value='');
  $('mtDate').value=fmtDate(new Date()); $('mtSyncCal').checked=true;
  $('addMtForm').style.display='block';
}
async function saveMeeting(){
  const t=$('mtTitle').value.trim();if(!t){showToast('ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”');return}
  const m=getMeetings(curProjId);
  const mtDate=$('mtDate').value, mtTime=$('mtTime').value, mtNotes=$('mtNotes').value;
  
  m.unshift({title:t,date:mtDate,time:mtTime,attendees:$('mtAttendees').value,notes:mtNotes});
  setMeetings(curProjId,m);$('addMtForm').style.display='none';renderMeetings();
  showToast('íšŒì˜ ê¸°ë¡ ì €ì¥ âœ“');

  // ìº˜ë¦°ë” ìë™ ì—°ë™
  if($('mtSyncCal').checked){
    const evt={title:`[íšŒì˜] ${t}`,date:mtDate,startTime:mtTime,endTime:'',type:'meeting',projectId:curProjId,note:mtNotes,alarms:[], done:false, repeatType:'none', author: currentUser ? currentUser.email : ''};
    if(fbReady){
      await window._fb.addDoc(getColl('events'),{...evt,createdAt:window._fb.serverTimestamp()});
    } else {
      evt._lid='e_'+Date.now(); localEvents.push(evt); saveLocal(); renderCal(); renderWeekView(); renderDayEvts();
    }
    showToast('ìº˜ë¦°ë”ì— ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ“…');
  }
}
function deleteMt(i){const m=getMeetings(curProjId);m.splice(i,1);setMeetings(curProjId,m);renderMeetings()}

// â”€â”€ Project Notes â”€â”€
function getProjNotes(pid){return JSON.parse(localStorage.getItem('pn_'+pid)||'[]')}
function setProjNotes(pid,d){localStorage.setItem('pn_'+pid,JSON.stringify(d))}
function renderProjNotes(){
  const n=getProjNotes(curProjId);
  $('projNoteList').innerHTML=!n.length?'<div class="empty"><div class="ei">ğŸ“</div><p>ë©”ëª¨ë¥¼ ì¶”ê°€í•´ ë³´ì„¸ìš”</p></div>':
    n.map((nt,i)=>`<div class="note-item"><div style="display:flex;justify-content:space-between"><strong>${nt.title||'ë©”ëª¨'}</strong>
      <button class="btn btn-ic btn-sm" style="background:transparent;border:none;color:var(--red)" onclick="deleteProjNote(${i})">ğŸ—‘</button></div>
      <div style="margin-top:6px">${nt.content.replace(/\n/g,'<br>')}</div>
      <div style="font-size:11px;color:var(--muted);margin-top:6px">${nt.createdAt}</div></div>`).join('');
}
function openAddProjNote(){['pnTitle','pnContent'].forEach(id=>$(id).value='');$('addPnForm').style.display='block'}
function saveProjNote(){
  const c=$('pnContent').value.trim();if(!c){showToast('ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”');return}
  const n=getProjNotes(curProjId);
  n.unshift({title:$('pnTitle').value||'ë©”ëª¨',content:c,createdAt:new Date().toLocaleDateString('ko-KR')});
  setProjNotes(curProjId,n);$('addPnForm').style.display='none';renderProjNotes();showToast('ë©”ëª¨ ì €ì¥ âœ“');
}
function deleteProjNote(i){const n=getProjNotes(curProjId);n.splice(i,1);setProjNotes(curProjId,n);renderProjNotes()}

// â”€â”€ Linked Notes â”€â”€
function renderLinkedNotes(){
  const pid=curProjId;
  const notes=localNotes.filter(n=>n.linkType==='project'&&n.linkTargetId===pid);
  const el=$('linkedNotesArea');
  let html=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
    <div style="font-size:13px;font-weight:600">ì´ í”„ë¡œì íŠ¸ì— ì—°ê²°ëœ ë…¸íŠ¸ (${notes.length}ê°œ)</div>
    <button class="btn btn-p btn-sm" onclick="openNoteModalWithLink('project','${pid}')">+ ë…¸íŠ¸ ì¶”ê°€</button></div>`;
  if(!notes.length) html+='<div class="empty"><div class="ei">ğŸ”—</div><p>ì—°ê²°ëœ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
  else html+=notes.map(n=>`<div class="linked-note" onclick="openNoteDetail('${n.id||n._lid}')">
    <div style="flex:1"><div class="ln-title">${n.title||'(ì œëª© ì—†ìŒ)'}</div><div class="ln-preview">${(n.content||'').substring(0,80)}</div></div>
    <span style="font-size:11px;color:var(--muted);flex-shrink:0">${n.createdAt||''}</span></div>`).join('');
  el.innerHTML=html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  âœ… ì—…ë¬´ ê´€ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onTaskTypeChange(val){
  $('weeklyPicker').classList.remove('show'); $('monthlyPicker').classList.remove('show');
  $('taskDateWrap').style.display = 'none'; 
  if(val==='recurring-weekly') $('weeklyPicker').classList.add('show');
  if(val==='recurring-monthly'){ $('monthlyPicker').classList.add('show'); buildDateBtns(); }
  if(val==='adhoc') $('taskDateWrap').style.display = 'block';
}
function toggleDay(btn){ btn.classList.toggle('sel') }
function buildDateBtns(){
  const c=$('monthlyDates'); if(c.children.length)return;
  c.innerHTML=Array.from({length:31},(_,i)=>`<button type="button" class="date-btn" data-d="${i+1}" onclick="this.classList.toggle('sel')">${i+1}</button>`).join('');
}
function getSelDays(){ return[...document.querySelectorAll('.day-btn.sel')].map(b=>parseInt(b.dataset.d)) }
function getSelDates(){ return[...document.querySelectorAll('.date-btn.sel')].map(b=>parseInt(b.dataset.d)) }

function renderTaskRepeatInfo(t){
  if(t.type==='recurring-weekly'&&t.repeatDays&&t.repeatDays.length)
    return`<div class="rec-repeat">${t.repeatDays.map(d=>`<span class="rep-chip">${DAY_KR[d]}ìš”ì¼</span>`).join('')}</div>`;
  if(t.type==='recurring-monthly'&&t.repeatDates&&t.repeatDates.length)
    return`<div class="rec-repeat">${t.repeatDates.map(d=>`<span class="rep-chip monthly">${d}ì¼</span>`).join('')}</div>`;
  return '';
}

function renderTasks(){
  const recurring=localTasks.filter(t=>t.type&&t.type.startsWith('recurring'));
  const adhoc=localTasks.filter(t=>t.type==='adhoc');
  const typeIcon={'recurring-daily':'ğŸ”','recurring-weekly':'ğŸ“†','recurring-monthly':'ğŸ—“','adhoc':'âš¡'};
  const typeLabel={'recurring-daily':'ë§¤ì¼','recurring-weekly':'ë§¤ì£¼','recurring-monthly':'ë§¤ì›”','adhoc':'ìˆ˜ì‹œ'};
  const iconCls={'recurring-daily':'ic-daily','recurring-weekly':'ic-weekly','recurring-monthly':'ic-monthly','adhoc':'ic-adhoc'};
  const ptag={high:'<span class="tag tag-r">ë†’ìŒ</span>',medium:'<span class="tag tag-a">ë³´í†µ</span>',low:'<span class="tag tag-g">ë‚®ìŒ</span>'};
  const renderList=(tasks,elId)=>{
    $(elId).innerHTML=!tasks.length
      ?`<div class="empty"><div class="ei">${elId==='recurringList'?'ğŸ”':'âš¡'}</div><p>ì—†ìŒ</p></div>`
      :tasks.map(t=>{const tid=t.id||t._lid;const nc=getLinkedNoteCount('task',tid);return`<div class="rec-card" onclick="openTaskDetail('${tid}')">
          <div class="rec-icon ${iconCls[t.type]||'ic-adhoc'}">${typeIcon[t.type]||'âš¡'}</div>
          <div class="rec-info">
            <div class="rec-title">${t.title}</div>
            <div class="rec-meta">${typeLabel[t.type]}${t.time?' Â· â° '+t.time:''}${t.targetDate?' Â· ğŸ“… '+t.targetDate:''}${t.assignee?' Â· ğŸ‘¤ '+t.assignee:''}${t.desc?' Â· '+t.desc:''}</div>
            ${renderTaskRepeatInfo(t)}
            ${nc>0?`<div style="margin-top:6px"><span class="link-badge lb-task">ğŸ“ ì—°ê²° ë…¸íŠ¸ ${nc}ê°œ</span></div>`:''}
          </div>
          <div style="display:flex;align-items:center;gap:6px">${ptag[t.priority]||''}
            <button class="btn btn-ic btn-sm" style="color:var(--red)" onclick="event.stopPropagation();deleteTask('${tid}')">ğŸ—‘</button>
          </div></div>`}).join('');
  };
  renderList(recurring,'recurringList'); renderList(adhoc,'adHocList');
  $('allTasksList').innerHTML=!localTasks.length
    ?'<div class="empty"><div class="ei">âœ…</div><p>ì—…ë¬´ ì—†ìŒ</p></div>'
    :localTasks.map(t=>`<div class="task-item"><div class="t-check"></div>
        <div class="t-body"><div class="t-title">${t.title}</div>
        <div class="t-meta">${typeIcon[t.type]} ${typeLabel[t.type]}${t.time?' Â· â° '+t.time:''}${t.targetDate?' Â· ğŸ“… '+t.targetDate:''}${t.assignee?' Â· ğŸ‘¤ '+t.assignee:''}${t.desc?' Â· '+t.desc:''}</div></div>
        ${ptag[t.priority]||''}</div>`).join('');
}

function openAddTask(){
  $('taskModalTitle').textContent='ì—…ë¬´ ì¶”ê°€';
  ['taskTitle','taskAssignee','taskDesc','taskTime','taskDate'].forEach(id=>$(id).value='');
  $('taskType').value='recurring-weekly'; $('taskPriority').value='medium'; $('taskEditId').value='';
  document.querySelectorAll('.day-btn, .date-btn').forEach(b=>b.classList.remove('sel'));
  $('monthlyDates').innerHTML=''; onTaskTypeChange('recurring-weekly');
  openModal('moAddTask');
}

function openEditTask(){
  const t=localTasks.find(x=>(x.id||x._lid)===curTaskId); if(!t)return;
  $('taskModalTitle').textContent='ì—…ë¬´ ìˆ˜ì •';
  $('taskTitle').value=t.title||''; $('taskAssignee').value=t.assignee||'';
  $('taskDesc').value=t.desc||''; $('taskTime').value=t.time||'';
  $('taskDate').value=t.targetDate||'';
  $('taskType').value=t.type||'recurring-weekly'; $('taskPriority').value=t.priority||'medium';
  $('taskEditId').value=curTaskId;
  
  document.querySelectorAll('.day-btn, .date-btn').forEach(b=>b.classList.remove('sel'));
  $('monthlyDates').innerHTML=''; onTaskTypeChange(t.type||'recurring-weekly');
  if(t.repeatDays) document.querySelectorAll('.day-btn').forEach(b=>{ if(t.repeatDays.includes(parseInt(b.dataset.d))) b.classList.add('sel'); });
  if(t.repeatDates) document.querySelectorAll('.date-btn').forEach(b=>{ if(t.repeatDates.includes(parseInt(b.dataset.d))) b.classList.add('sel'); });
  closeModal('moTaskDetail'); openModal('moAddTask');
}

async function saveTask(){
  const title=$('taskTitle').value.trim(); if(!title){showToast('ì—…ë¬´ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”');return}
  const type=$('taskType').value; const editId=$('taskEditId').value;
  const task={title,type,priority:$('taskPriority').value,assignee:$('taskAssignee').value,desc:$('taskDesc').value,time:$('taskTime').value,
    targetDate: type==='adhoc'?$('taskDate').value:'',
    repeatDays:type==='recurring-weekly'?getSelDays():[],
    repeatDates:type==='recurring-monthly'?getSelDates():[],
    author: currentUser ? currentUser.email : ''};
  if(editId){
    if(fbReady){await window._fb.updateDoc(getDoc('tasks', editId),task)}
    else{const idx=localTasks.findIndex(t=>(t.id||t._lid)===editId);if(idx>=0)localTasks[idx]={...localTasks[idx],...task};saveLocal();renderTasks();renderCal();renderWeekView();renderDayEvts()}
    showToast('ì—…ë¬´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“');
  } else {
    if(fbReady){await window._fb.addDoc(getColl('tasks'),{...task,createdAt:window._fb.serverTimestamp()})}
    else{task._lid='t_'+Date.now();localTasks.push(task);saveLocal();renderTasks();renderCal();renderWeekView();renderDayEvts()}
    showToast('ì—…ë¬´ ë“±ë¡ âœ“');
  }
  closeModal('moAddTask');
}

async function deleteTask(id){
  if(fbReady){await window._fb.deleteDoc(getDoc('tasks', id))}
  else{localTasks=localTasks.filter(t=>(t.id||t._lid)!==id);saveLocal();renderTasks();renderCal();renderWeekView();renderDayEvts()}
}
function getTaskName(tid){const t=localTasks.find(x=>(x.id||x._lid)===tid);return t?t.title:''}

async function toggleTaskDone(tid, dateStr) {
  const t = localTasks.find(x => (x.id || x._lid) === tid);
  if (!t) return;
  
  if (!t.completedDates) t.completedDates = [];
  const idx = t.completedDates.indexOf(dateStr);
  if (idx > -1) t.completedDates.splice(idx, 1);
  else t.completedDates.push(dateStr);
  
  if (fbReady) {
    await window._fb.updateDoc(getDoc('tasks', tid), { completedDates: t.completedDates });
  } else {
    saveLocal(); renderCal(); renderWeekView(); renderDayEvts();
  }
}

async function toggleTaskDoneFromDetail() {
  if (!curTaskId || !curTaskDate) return;
  await toggleTaskDone(curTaskId, curTaskDate);
  openTaskDetail(curTaskId, curTaskDate); 
}


// â”€â”€ Task Detail â”€â”€
const typeIconMap={'recurring-daily':'ğŸ”','recurring-weekly':'ğŸ“†','recurring-monthly':'ğŸ—“','adhoc':'âš¡'};
const typeLabelMap={'recurring-daily':'ë§¤ì¼ ë°˜ë³µ','recurring-weekly':'ë§¤ì£¼ ë°˜ë³µ','recurring-monthly':'ë§¤ì›” ë°˜ë³µ','adhoc':'ìˆ˜ì‹œ ì—…ë¬´'};
const priorityTagMap={high:'<span class="tag tag-r">ë†’ìŒ ğŸ”´</span>',medium:'<span class="tag tag-a">ë³´í†µ</span>',low:'<span class="tag tag-g">ë‚®ìŒ ğŸŸ¢</span>'};

function openTaskDetail(tid, dateStr){
  curTaskId=tid;
  curTaskDate=dateStr || fmtDate(selDate);
  const t=localTasks.find(x=>(x.id||x._lid)===tid); if(!t)return;
  
  const isDone = t.completedDates && t.completedDates.includes(curTaskDate);
  $('tdTitle').innerHTML=(isDone?'<span style="color:var(--green);margin-right:6px">âœ“</span>':'')+t.title;
  $('tdPriorityBadge').innerHTML=priorityTagMap[t.priority]||'';
  
  let meta=`${typeIconMap[t.type]||'âš¡'} ${typeLabelMap[t.type]||''}`;
  if(t.time) meta+=` Â· â° ${t.time}`;
  if(t.targetDate) meta+=` Â· ğŸ“… ëª©í‘œì¼: ${t.targetDate}`;
  if(t.assignee) meta+=` Â· ğŸ‘¤ ${t.assignee}`;
  meta+= ` Â· ğŸ“Œ ê¸°ì¤€ì¼: ${curTaskDate}`;
  $('tdMeta').textContent=meta;
  
  let repeatHtml='';
  if(t.type==='recurring-weekly'&&t.repeatDays&&t.repeatDays.length)
    repeatHtml=`<div style="background:var(--accent-l);border-radius:var(--rs);padding:12px 14px"><div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:8px">ë°˜ë³µ ìš”ì¼</div><div class="rec-repeat">${t.repeatDays.map(d=>`<span class="rep-chip">${DAY_KR[d]}ìš”ì¼</span>`).join('')}</div></div>`;
  else if(t.type==='recurring-monthly'&&t.repeatDates&&t.repeatDates.length)
    repeatHtml=`<div style="background:var(--warn-l);border-radius:var(--rs);padding:12px 14px"><div style="font-size:11px;font-weight:700;color:var(--warn);margin-bottom:8px">ë°˜ë³µ ë‚ ì§œ</div><div class="rec-repeat">${t.repeatDates.map(d=>`<span class="rep-chip monthly">${d}ì¼</span>`).join('')}</div></div>`;
  else if(t.type==='recurring-daily')
    repeatHtml=`<div style="background:var(--accent-l);border-radius:var(--rs);padding:12px 14px;font-size:13px;color:var(--accent);font-weight:500">ğŸ” ë§¤ì¼ ë°˜ë³µë˜ëŠ” ì—…ë¬´ì…ë‹ˆë‹¤</div>`;
  $('tdRepeatInfo').innerHTML=repeatHtml; $('tdDesc').textContent=t.desc||'(ì„¤ëª… ì—†ìŒ)';
  
  const doneBtn = $('tdDoneBtn');
  if(doneBtn) {
    if(isDone) {
      doneBtn.textContent = 'âœ“ ì™„ë£Œ ì·¨ì†Œ (ë¯¸ì™„ë£Œ)';
      doneBtn.classList.remove('btn-s');
      doneBtn.classList.add('btn-p');
    } else {
      doneBtn.textContent = 'âœ“ ì´ ë‚ ì§œ ì™„ë£Œ ì²˜ë¦¬';
      doneBtn.classList.remove('btn-p');
      doneBtn.classList.add('btn-s');
    }
  }

  switchTaskTab('info'); renderLinkedTaskNotes(); openModal('moTaskDetail');
}
function switchTaskTab(tab){
  ['info','notes'].forEach(t=>$('tt-'+t).classList.toggle('active',t===tab));
  document.querySelectorAll('#moTaskDetail .m-tab').forEach((el,i)=>el.classList.toggle('active',['info','notes'][i]===tab));
}
function renderLinkedTaskNotes(){
  const notes=localNotes.filter(n=>n.linkType==='task'&&n.linkTargetId===curTaskId);
  $('tdNoteCount').textContent=`ì´ ì—…ë¬´ì— ì—°ê²°ëœ ë…¸íŠ¸ (${notes.length}ê°œ)`;
  $('tdLinkedNotes').innerHTML=!notes.length?'<div class="empty"><div class="ei">ğŸ”—</div><p>ì—°ê²°ëœ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>':
    notes.map(n=>`<div class="linked-note" onclick="openNoteDetail('${n.id||n._lid}')">
      <div style="flex:1"><div class="ln-title">${n.title||'(ì œëª© ì—†ìŒ)'}</div><div class="ln-preview">${(n.content||'').substring(0,80)}</div></div>
      <span style="font-size:11px;color:var(--muted);flex-shrink:0">${n.createdAt||''}</span></div>`).join('');
}
function openNoteFromTask(){ closeModal('moTaskDetail'); openNoteModal(null,curTaskId); }
function deleteTaskFromDetail(){ if(!confirm('ì´ ì—…ë¬´ë¥¼ ì‚­ì œí• ê¹Œìš”?'))return; deleteTask(curTaskId); closeModal('moTaskDetail'); showToast('ì—…ë¬´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ğŸ“ ë…¸íŠ¸ ì‹œìŠ¤í…œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNotesPage(){
  const g=$('notesGrid');
  let notes=[...localNotes].reverse();
  if(noteFilter==='none')notes=notes.filter(n=>!n.linkType||n.linkType==='none');
  else if(noteFilter==='project')notes=notes.filter(n=>n.linkType==='project');
  else if(noteFilter==='task')notes=notes.filter(n=>n.linkType==='task');
  if(!notes.length){g.innerHTML='<div class="empty" style="grid-column:1/-1"><div class="ei">ğŸ“</div><p>ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';return}
  g.innerHTML=notes.map(n=>{
    const nid=n.id||n._lid;
    let badge='';
    if(n.linkType==='project'&&n.linkTargetId) badge=`<span class="link-badge lb-proj" onclick="event.stopPropagation();openProjDetail('${n.linkTargetId}')">ğŸ“ ${getProjName(n.linkTargetId)||'í”„ë¡œì íŠ¸'}</span>`;
    else if(n.linkType==='task'&&n.linkTargetId) badge=`<span class="link-badge lb-task" onclick="event.stopPropagation();openTaskDetail('${n.linkTargetId}')">âœ… ${getTaskName(n.linkTargetId)||'ì—…ë¬´'}</span>`;
    return`<div class="note-card nc-${n.color||'yellow'}" onclick="openNoteDetail('${nid}')">
      <div class="nc-body"><div class="nc-title">${n.title||'(ì œëª© ì—†ìŒ)'}</div>
      <div class="nc-preview">${(n.content||'').replace(/</g,'&lt;')}</div></div>
      <div class="nc-foot"><span>${n.createdAt||''}</span>${badge}</div></div>`;
  }).join('');
}
function setNoteFilter(f,btn){ noteFilter=f; document.querySelectorAll('.f-btn').forEach(b=>b.classList.remove('active')); if(btn)btn.classList.add('active'); renderNotesPage(); }
function openNoteModal(prefProj,prefTask){
  $('noteMoTitle').textContent='ìƒˆ ë…¸íŠ¸'; ['noteTitle','noteContent'].forEach(id=>$(id).value='');
  $('noteColor').value='yellow'; $('noteEditId').value=''; $('noteDelBtn').style.display='none';
  if(prefProj){$('noteLinkType').value='project';onNoteLinkChange('project');$('noteLinkTarget').value=prefProj}
  else if(prefTask){$('noteLinkType').value='task';onNoteLinkChange('task');$('noteLinkTarget').value=prefTask}
  else{$('noteLinkType').value='none';onNoteLinkChange('none')}
  openModal('moNote');
}
function openNoteModalWithLink(type,tid){ closeModal('moProjDetail'); openNoteModal(type==='project'?tid:null,type==='task'?tid:null); }
function onNoteLinkChange(val){
  const grp=$('noteLinkGroup'),sel=$('noteLinkTarget'),lbl=$('noteLinkLabel');
  if(val==='none'){grp.style.display='none';return}
  grp.style.display='block';
  if(val==='project'){lbl.textContent='ì—°ê²°í•  í”„ë¡œì íŠ¸';sel.innerHTML=!localProjects.length?'<option value="">í”„ë¡œì íŠ¸ ì—†ìŒ</option>':localProjects.map(p=>`<option value="${p.id||p._lid}">${p.name}</option>`).join('')}
  else{lbl.textContent='ì—°ê²°í•  ì—…ë¬´';sel.innerHTML=!localTasks.length?'<option value="">ì—…ë¬´ ì—†ìŒ</option>':localTasks.map(t=>`<option value="${t.id||t._lid}">${t.title}</option>`).join('')}
}
async function saveNote(){
  const content=$('noteContent').value.trim(); if(!content){showToast('ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”');return}
  const editId=$('noteEditId').value; const linkType=$('noteLinkType').value;
  const noteData={title:$('noteTitle').value.trim()||'(ì œëª© ì—†ìŒ)',content,color:$('noteColor').value,linkType,
    linkTargetId:linkType!=='none'?$('noteLinkTarget').value:'',createdAt:new Date().toLocaleDateString('ko-KR'), author: currentUser ? currentUser.email : ''};
  if(editId){
    if(fbReady){await window._fb.updateDoc(getDoc('notes', editId),noteData)}
    else{const idx=localNotes.findIndex(n=>(n.id||n._lid)===editId);if(idx>=0)localNotes[idx]={...localNotes[idx],...noteData};saveLocal();renderNotesPage()}
    showToast('ë…¸íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“');
  } else {
    if(fbReady){await window._fb.addDoc(getColl('notes'),{...noteData,createdAt:window._fb.serverTimestamp()})}
    else{noteData._lid='n_'+Date.now();localNotes.push(noteData);saveLocal();renderNotesPage()}
    showToast('ë…¸íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ âœ“');
  }
  closeModal('moNote');
}
async function deleteNote(){
  const editId=$('noteEditId').value; if(!editId)return;
  if(!confirm('ì´ ë…¸íŠ¸ë¥¼ ì‚­ì œí• ê¹Œìš”?'))return;
  if(fbReady){await window._fb.deleteDoc(getDoc('notes', editId))}
  else{localNotes=localNotes.filter(n=>(n.id||n._lid)!==editId);saveLocal();renderNotesPage()}
  closeModal('moNote'); showToast('ë…¸íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}
function openNoteDetail(nid){
  const n=localNotes.find(x=>(x.id||x._lid)===nid); if(!n)return;
  curNoteId=nid; $('ndTitle').textContent=n.title||'(ì œëª© ì—†ìŒ)'; $('ndContent').textContent=n.content||'';
  let links='';
  if(n.linkType==='project'&&n.linkTargetId) links=`<span class="link-badge lb-proj" onclick="closeModal('moNoteDetail');openProjDetail('${n.linkTargetId}')">ğŸ“ ${getProjName(n.linkTargetId)||'í”„ë¡œì íŠ¸'} ì—´ê¸°</span>`;
  else if(n.linkType==='task'&&n.linkTargetId) links=`<span class="link-badge lb-task" onclick="closeModal('moNoteDetail');openTaskDetail('${n.linkTargetId}')">âœ… ${getTaskName(n.linkTargetId)||'ì—…ë¬´'} ì—´ê¸°</span>`;
  $('ndLinks').innerHTML=links; $('ndMeta').textContent=`ì‘ì„±ì¼: ${n.createdAt||''} Â· ìƒ‰ìƒ: ${COLOR_LBL[n.color]||''}`;
  openModal('moNoteDetail');
}
function editNoteFromDetail(){
  const n=localNotes.find(x=>(x.id||x._lid)===curNoteId); if(!n)return;
  closeModal('moNoteDetail'); $('noteMoTitle').textContent='ë…¸íŠ¸ ìˆ˜ì •';
  $('noteTitle').value=n.title||''; $('noteContent').value=n.content||'';
  $('noteColor').value=n.color||'yellow'; $('noteEditId').value=curNoteId; $('noteDelBtn').style.display='inline-flex';
  $('noteLinkType').value=n.linkType||'none'; onNoteLinkChange(n.linkType||'none');
  if(n.linkType&&n.linkType!=='none') $('noteLinkTarget').value=n.linkTargetId||'';
  openModal('moNote');
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateCalTitle(); renderCal(); selectDate(fmtDate(new Date())); updateEvtProjSel(); updateAlarmPanel(); buildDateBtns();
if('Notification'in window){
  if(Notification.permission==='granted'){startAlarmChecker();$('alarmSidebarStatus').textContent='ğŸ”” ì•ŒëŒ í™œì„±í™”ë¨'}
  else if(Notification.permission==='default') $('notifBanner').style.display='flex';
  else $('alarmSidebarStatus').textContent='ğŸ”• ì•ŒëŒ ë¹„í™œì„±í™”';
} else $('alarmSidebarStatus').textContent='âš ï¸ ì•ŒëŒ ë¯¸ì§€ì› ë¸Œë¼ìš°ì €';
</script>
</body>
</html>
